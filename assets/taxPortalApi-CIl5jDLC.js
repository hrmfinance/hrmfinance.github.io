import{aG as f,h as l,P as c,Q as R,e as K}from"./index-Bg2EUb5G.js";import{a as X}from"./drakeTypes-DcjcYEfx.js";const le=async t=>{try{const e=l.state.profile;e?.uid;const r=Date.now(),s={...t,id:R(),businessId:l.getBusinessId(),createdAt:r,updatedAt:r,createdBy:e.uid,documentCount:0,verifiedDocumentCount:0},a={query:"addTaxPortal",params:{businessId:l.getBusinessId()},form:s};return K("Creating tax portal:",a),(await c(a))?.taxPortal||s}catch(e){throw console.error("Error creating tax portal:",e),new Error("Error al crear el portal de impuestos")}},de=async t=>{try{if(!l.state.user)throw new Error("Usuario no autenticado");let r={businessId:l.getBusinessId()};t&&t.trim();let i=((await c({query:"getTaxPortal",params:r}))?.data||[]).filter(d=>d.type==="document"||d.type==="checklist"?!1:d.firstName||d.lastName);if(!l.isAdmin()){const d=l.getAllowedStoreIds();i=i.filter(h=>h.storeId?d.includes(h.storeId):!0)}return i}catch(e){return console.error("Error getting tax portals:",e),[]}},ce=async t=>{try{const e={query:"getTaxPortal",params:{businessId:l.getBusinessId(),id:t}},r=await c(e);return(r?.data?.taxPortal||r?.data||r?.taxPortal).filter(o=>o.id===t)?.[0]||null}catch(e){return console.error("Error getting tax portal:",e),null}},ue=async(t,e)=>{try{const r={query:"updateTaxPortal",params:{businessId:l.getBusinessId(),id:t},form:{...e,updatedAt:Date.now()}};return(await c(r))?.taxPortal||{id:t,...e}}catch(r){throw console.error("Error updating tax portal:",r),new Error("Error al actualizar el portal de impuestos")}},me=async t=>{try{const e={query:"deleteTaxPortal",params:{businessId:l.getBusinessId(),id:t}};await c(e)}catch(e){throw console.error("Error deleting tax portal:",e),new Error("Error al eliminar el portal de impuestos")}},Z=()=>{const t=Date.now().toString(36),e=Math.random().toString(36).substring(2,12);return`TDR-${t}-${e}`.toUpperCase()},ee=()=>Math.floor(1e5+Math.random()*9e5).toString(),te=(t,e)=>{const r=`${window.location.origin}/#/tax-upload/${t}/${e}`;return`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(r)}`},he=async(t,e)=>{try{const r=l.state.profile;r?.uid;const s=Date.now(),a=e.expirationDays||30,o=Z(),i=R(),d={id:i,title:e?.task?.title,taxPortalId:t?.id,recipientName:`${t?.firstName} ${t?.lastName}`.trim(),clientName:`${t?.firstName} ${t?.lastName}`.trim(),clientEmail:t?.email,recipientEmail:t?.email,clientPhone:t?.phone,accessToken:o,accessPin:ee(),qrCodeUrl:te(i,o),taxYear:e.taxYear,requestedDocuments:e.requestedDocuments||[...X],instructions:e.instructions,status:"pending",uploadedDocuments:[],createdAt:s,expiresAt:s+a*24*60*60*1e3,requestedBy:r.uid,requestedByName:r.displayName||r.email||"Unknown",businessId:l.getBusinessId()||"",storeId:t?.storeId,storeName:t?.storeName},h={query:"addTaxDocumentRequest",params:{businessId:l.getBusinessId()},form:d};return(await c(h))?.documentRequest||d}catch(r){throw console.error("Error creating document request:",r),new Error("Error al crear la solicitud de documentos")}},ye=async(t,e,r)=>{try{const o=(await f({query:"getTaxDocumentRequestByToken",params:{accessToken:e,id:t,verifySignature:r}}))?.data;if(!o)return null;o.expiresAt<Date.now()&&o.status==="pending"&&(o.status="expired");try{await k(o.id,o.businessId)}catch{}return o}catch(s){return console.error("Error getting document request by token:",s),null}},pe=async(t,e,r)=>{try{const o=(await f({query:"getSignatureValidationByToken",params:{accessToken:e,id:t,verifySignature:r}}))?.data;if(!o)return null;o.expiresAt<Date.now()&&o.status==="pending"&&(o.status="expired");try{await k(o.id,o.businessId)}catch{}return o}catch(s){return console.error("Error getting document request by token:",s),null}},ge=async t=>{try{const s=(await c({query:"getTaxDocumentRequestByPin",params:{accessPin:t}}))?.documentRequest;if(!s)return null;s.expiresAt<Date.now()&&s.status==="pending"&&(s.status="expired");try{await k(s.id,s.businessId)}catch{}return s}catch(e){return console.error("Error getting document request by PIN:",e),null}},k=async(t,e)=>{const r={query:"updateTaxDocumentRequestLastAccess",params:{businessId:e,id:t},form:{lastAccessedAt:Date.now()}};await f(r)},fe=async t=>{try{const e={query:"getTaxDocumentRequestsByRecipient",params:{businessId:l.getBusinessId(),recipientId:t}},r=await c(e);return r?.data?.data||r?.data||[]}catch(e){return console.error("Error getting document requests:",e),[]}},be=async t=>{try{if(!l.state.user)throw new Error("Usuario no autenticado");const r={query:"getTaxDocumentRequests",params:{businessId:l.getBusinessId()}},s=await c(r);let a=s?.data?.data||s?.data||[];if(!l.isAdmin()){const o=l.getAllowedStoreIds();a=a.filter(i=>i.storeId?o.includes(i.storeId):!0)}return t?.status,t?.taxYear,a.sort((o,i)=>i.createdAt-o.createdAt),a}catch(e){return console.error("Error getting document requests:",e),[]}},we=async(t,e,r,s)=>{try{const i=(await c({query:"getTaxDocumentRequestById",params:{businessId:e,id:t}}))?.documentRequest;if(!i)throw new Error("Request not found");const d=i.requestedDocuments.map(u=>u.type===r?{...u,uploaded:!0,documentId:s}:u),h=d.filter(u=>u.required).every(u=>u.uploaded),y=d.some(u=>u.uploaded),p={query:"updateTaxDocumentRequest",params:{businessId:e,id:t},form:{requestedDocuments:d,uploadedDocuments:[...i.uploadedDocuments||[],s],status:h?"complete":y?"partial":"pending"}};await c(p)}catch(a){throw console.error("Error marking document uploaded:",a),a}},_e=async t=>{try{const e={query:"updateTaxDocumentRequest",params:{businessId:l.getBusinessId(),id:t},form:{status:"cancelled"}};await c(e)}catch(e){throw console.error("Error cancelling document request:",e),new Error("Error al cancelar la solicitud")}},Ie=async t=>{try{const e={query:"deleteTaxDocumentRequest",params:{businessId:l.getBusinessId(),id:t}};await c(e)}catch(e){throw console.error("Error deleting document request:",e),new Error("Error al eliminar la solicitud")}},qe=async t=>{try{const e={query:"sendTaxDocumentRequestReminder",params:{businessId:l.getBusinessId(),id:t}},r=await c(e);r?.success&&await c({query:"updateTaxDocumentRequest",params:{businessId:l.getBusinessId(),id:t},form:{remindersSent:(r.remindersSent||0)+1}})}catch(e){throw console.error("Error sending reminder:",e),new Error("Error al enviar el recordatorio")}},xe=async(t,e,r,s)=>{try{const a={query:"markDocumentNotNeeded",params:{businessId:l.getBusinessId(),id:t,documentType:e,notNeeded:r,reason:s,markedBy:"accountant",markedAt:Date.now()}},o=await c(a);return{success:!0}}catch(a){return console.error("Error marking document as not needed:",a),{success:!1,error:"Error updating document status"}}},De=t=>`${window.location.origin}/#/tax-upload/${t}`,Te=()=>`${window.location.origin}/#/tax-upload-pin`,Ee=t=>{const e=Date.now(),r=t-e;if(r<=0)return"Expirado";const s=Math.floor(r/(24*60*60*1e3)),a=Math.floor(r%(24*60*60*1e3)/(60*60*1e3));return s>0?`${s} día${s>1?"s":""} restante${s>1?"s":""}`:`${a} hora${a>1?"s":""} restante${a>1?"s":""}`},Se=t=>t.expiresAt<Date.now(),Be=t=>{const e=t.requestedDocuments.length,r=t.requestedDocuments.filter(s=>s.uploaded).length;return Math.round(r/e*100)},Re=t=>t.requestedDocuments.filter(e=>e.required&&!e.uploaded),ke=async(t,e,r,s)=>{try{const a=await f({query:"updateTaxDocumentRequest",params:{requestId:t,id:t,accessToken:e,businessId:s},form:r});return{success:!0}}catch(a){return console.error("Error updating document request:",a),{success:!1,error:a.message}}};async function Pe(t,e,r,s){try{const a=await t.arrayBuffer(),o=Array.from(new Uint8Array(a)),i=await f({query:"uploadTaxDocument",params:{businessId:s?.businessId||l.getBusinessId()},form:{fileBuffer:o,fileName:t.name,mimeType:t.type,fileSize:t.size,taxPortalId:e,taxYear:r,businessId:s?.businessId||l.getBusinessId(),documentType:s?.documentType,tags:s?.tags,notes:s?.notes}});return i?.success&&i?.documentId?{success:!0,documentId:i.documentId,document:i.document}:{success:!1,error:i?.error||"Failed to upload document"}}catch(a){return console.error("Error uploading tax document:",a),{success:!1,error:a.message}}}const re=t=>{const e={2024:{taxYear:2024,standardDeductions:{single:14600,married_jointly:29200,married_separately:14600,head_of_household:21900,qualifying_widow:29200},taxBrackets:{single:[{limit:11600,rate:.1,base:0,threshold:0},{limit:47150,rate:.12,base:1160,threshold:11600},{limit:100525,rate:.22,base:5426,threshold:47150},{limit:191950,rate:.24,base:17168.5,threshold:100525},{limit:243725,rate:.32,base:39110.5,threshold:191950},{limit:609350,rate:.35,base:55678.5,threshold:243725},{limit:1/0,rate:.37,base:183647.25,threshold:609350}],married_jointly:[{limit:23200,rate:.1,base:0,threshold:0},{limit:94300,rate:.12,base:2320,threshold:23200},{limit:201050,rate:.22,base:10852,threshold:94300},{limit:383900,rate:.24,base:34337,threshold:201050},{limit:487450,rate:.32,base:78221,threshold:383900},{limit:731200,rate:.35,base:111357,threshold:487450},{limit:1/0,rate:.37,base:196669.5,threshold:731200}],married_separately:[{limit:11600,rate:.1,base:0,threshold:0},{limit:47150,rate:.12,base:1160,threshold:11600},{limit:100525,rate:.22,base:5426,threshold:47150},{limit:191950,rate:.24,base:17168.5,threshold:100525},{limit:243725,rate:.32,base:39110.5,threshold:191950},{limit:365600,rate:.35,base:55678.5,threshold:243725},{limit:1/0,rate:.37,base:98334.75,threshold:365600}],head_of_household:[{limit:16550,rate:.1,base:0,threshold:0},{limit:63100,rate:.12,base:1655,threshold:16550},{limit:100500,rate:.22,base:7241,threshold:63100},{limit:191950,rate:.24,base:15469,threshold:100500},{limit:243700,rate:.32,base:37417,threshold:191950},{limit:609350,rate:.35,base:53977,threshold:243700},{limit:1/0,rate:.37,base:181954.5,threshold:609350}]},saltCap:1e4,saltCapMFS:5e3,additionalDeduction65Plus:{single:1950,married:1550}},2025:{taxYear:2025,standardDeductions:{single:15e3,married_jointly:3e4,married_separately:15e3,head_of_household:22500,qualifying_widow:3e4},taxBrackets:{single:[{limit:11925,rate:.1,base:0,threshold:0},{limit:48475,rate:.12,base:1192.5,threshold:11925},{limit:103350,rate:.22,base:5578.5,threshold:48475},{limit:197300,rate:.24,base:17651,threshold:103350},{limit:250525,rate:.32,base:40199,threshold:197300},{limit:626350,rate:.35,base:57231,threshold:250525},{limit:1/0,rate:.37,base:188769.75,threshold:626350}],married_jointly:[{limit:23850,rate:.1,base:0,threshold:0},{limit:96950,rate:.12,base:2385,threshold:23850},{limit:206700,rate:.22,base:11157,threshold:96950},{limit:394600,rate:.24,base:35302,threshold:206700},{limit:501050,rate:.32,base:80398,threshold:394600},{limit:751600,rate:.35,base:114462,threshold:501050},{limit:1/0,rate:.37,base:202154.5,threshold:751600}],married_separately:[{limit:11925,rate:.1,base:0,threshold:0},{limit:48475,rate:.12,base:1192.5,threshold:11925},{limit:103350,rate:.22,base:5578.5,threshold:48475},{limit:197300,rate:.24,base:17651,threshold:103350},{limit:250525,rate:.32,base:40199,threshold:197300},{limit:375800,rate:.35,base:57231,threshold:250525},{limit:1/0,rate:.37,base:101077.25,threshold:375800}],head_of_household:[{limit:17e3,rate:.1,base:0,threshold:0},{limit:64850,rate:.12,base:1700,threshold:17e3},{limit:103350,rate:.22,base:7442,threshold:64850},{limit:197300,rate:.24,base:15912,threshold:103350},{limit:250500,rate:.32,base:38460,threshold:197300},{limit:626350,rate:.35,base:55484,threshold:250500},{limit:1/0,rate:.37,base:187032,threshold:626350}]},saltCap:1e4,saltCapMFS:5e3,additionalDeduction65Plus:{single:2e3,married:1600}}};return e[t]||e[2024]},se={single:"Single",married_filing_jointly:"Married Filing Jointly",married_jointly:"Married Filing Jointly",married_filing_separately:"Married Filing Separately",married_separate:"Married Filing Separately",head_of_household:"Head of Household",head_household:"Head of Household",qualifying_widow:"Qualifying Surviving Spouse"},ae=t=>({married_jointly:"married_jointly",married_filing_jointly:"married_jointly",married_separate:"married_separately",married_filing_separately:"married_separately",head_household:"head_of_household",head_of_household:"head_of_household",single:"single",qualifying_widow:"qualifying_widow"})[t]||"single",Ae=async(t,e,r,s)=>{const a=re(e),o=ae(s.filingStatus||"single"),i=o==="married_separately";let d=0,h=0,y=0,p=0,u=0,_=0,I=0,q=0,x=0,D=0,P=0,A=0,U=0,$=0,M=0,N=0;r.forEach(m=>{if(m.verified&&m.extractedAmounts){const n=m.extractedAmounts;n.wages&&(d+=n.wages),n.interestIncome&&(y+=n.interestIncome),n.ordinaryDividends&&(p+=n.ordinaryDividends),n.nonEmployeeCompensation&&(u+=n.nonEmployeeCompensation),n.rents&&(_+=n.rents),n.royalties&&(I+=n.royalties),n.otherIncome&&(q+=n.otherIncome),n.federalTaxWithheld&&(x+=n.federalTaxWithheld),n.federalTaxWithheld1099&&(D+=n.federalTaxWithheld1099),n.stateTaxWithheld&&(P+=n.stateTaxWithheld),n.localTaxWithheld&&(A+=n.localTaxWithheld),n.propertyTaxes&&(U+=n.propertyTaxes),n.mortgageInterest&&($+=n.mortgageInterest),n.pointsPaid&&(M+=n.pointsPaid),n.mortgageInsurancePremiums&&(N+=n.mortgageInsurancePremiums)}});const C=d+h,v=u+_+I+q,j=C+y+p+v,T=x+D,E=a.standardDeductions[o]||a.standardDeductions.single,J=i?a.saltCapMFS:a.saltCap,V=P+A+U,L=Math.min(V,J),F=$+M+N,W=0,S=L+F+W,z=S>E,Q=z?S:E,H=0,O=j-H,B=Math.max(0,O-Q);let g;o==="married_jointly"||o==="qualifying_widow"?g=a.taxBrackets.married_jointly:o==="head_of_household"?g=a.taxBrackets.head_of_household:o==="married_separately"?g=a.taxBrackets.married_separately:g=a.taxBrackets.single;let b=0,Y="",G=0;for(const m of g)if(B<=m.limit){b=m.base+(B-m.threshold)*m.rate,G=m.rate,Y=`${(m.rate*100).toFixed(0)}% bracket ($${m.threshold.toLocaleString()} - $${m.limit===1/0?"∞":m.limit.toLocaleString()})`;break}const w=T-b;return{id:R(),taxPortalId:t,taxYear:e,filingStatus:o,filingStatusLabel:se[s.filingStatus||"single"]||"Single",calculatedAt:Date.now(),line1a_wages:d,line1h_otherEarnedIncome:h,line1z_totalWages:C,line2b_taxableInterest:y,line3b_ordinaryDividends:p,line8_otherIncome:v,line8_breakdown:{businessIncome:u,rentalIncome:_,royalties:I,other:q},line9_totalIncome:j,line10_adjustments:H,line11_agi:O,line12a_standardDeduction:E,line12b_itemizedDeductions:S,line12b_breakdown:{saltDeduction:L,mortgageInterest:F,charitableContributions:W},line12_deductionUsed:z?"itemized":"standard",line12_deductionAmount:Q,line15_taxableIncome:B,line16_tax:b,line16_bracketUsed:Y,line16_marginalRate:G,line24_totalTax:b,line25a_w2Withholding:x,line25b_1099Withholding:D,line25d_totalWithholding:T,line33_totalPayments:T,line34_refund:w>0?w:0,line37_amountOwed:w<0?Math.abs(w):0}};export{Be as a,De as b,Te as c,he as d,_e as e,Ee as f,fe as g,Ie as h,Se as i,de as j,be as k,le as l,me as m,xe as n,Ae as o,ce as p,ye as q,Re as r,qe as s,ke as t,ue as u,Pe as v,we as w,ge as x,pe as y};
