import{aJ as N,e as u,h as d,P as p,Q as pe}from"./index-BRw9R-ST.js";import{a as Ee}from"./drakeTypes-DGPIb3y3.js";const xe={2023:{1:14580,2:19720,3:24860,4:3e4,5:35140,6:40280,7:45420,8:50560},2024:{1:15060,2:20440,3:25820,4:31200,5:36580,6:41960,7:47340,8:52720},2025:{1:15650,2:21150,3:26650,4:32150,5:37650,6:43150,7:48650,8:54150},2026:{1:16e3,2:21600,3:27200,4:32800,5:38400,6:44e3,7:49600,8:55200}},_e={2023:5140,2024:5380,2025:5500,2026:5600};function Xe(t,e){const n=t-1,o=xe[n]||xe[2024],r=_e[n]||_e[2024];return e<=8?o[e]||o[1]:o[8]+(e-8)*r}function Re(t){const e=Math.round(t);return console.log(`[FORM 8962] Applicable % lookup: raw FPL%=${t.toFixed(2)}, rounded=${e}`),e<100||e<150?0:e<200?(e-150)/50*.02:e<250?.02+(e-200)/50*.02:e<300?.04+(e-250)/50*.02:e<400?.06+(e-300)/100*.025:.085}const Fe=[{maxFplPercent:200,limits:{single:375,other:750}},{maxFplPercent:300,limits:{single:950,other:1900}},{maxFplPercent:400,limits:{single:1575,other:3150}}],ke=[{maxFplPercent:200,limits:{single:400,other:800}},{maxFplPercent:300,limits:{single:1e3,other:2e3}},{maxFplPercent:400,limits:{single:1650,other:3300}}],Be=[{maxFplPercent:200,limits:{single:425,other:850}},{maxFplPercent:300,limits:{single:1050,other:2100}},{maxFplPercent:400,limits:{single:1725,other:3450}}];function Ne(t){return t===2024?Fe:t===2025?ke:Be}function Oe(t,e,n){if(e>=400)return null;const o=Ne(t),r=n==="single"||n==="married_filing_separately";for(const a of o)if(e<a.maxFplPercent)return r?a.limits.single:a.limits.other;return null}function ve(t){const{taxYear:e,householdIncome:n,familySize:o,filingStatus:r,form1095AData:a}=t,s=Xe(e,o),l=n/s*100,h=Re(l),T=n*h,L=T/12;let m=0,D=0,x=0,_=0;for(const g of a)m+=g.annualPremium,D+=g.annualSlcsp,x+=g.annualAptc,_=Math.max(_,g.coverageMonths||12);let f=0;const E=Math.round(L);if(a.length>0&&a[0].monthlyPremiums?.length===12)for(let g=0;g<12;g++){let q=0,b=0;for(const C of a)q+=C.monthlyPremiums?.[g]||0,b+=C.monthlySlcsp?.[g]||0;if(q>0&&b>0){const C=Math.max(0,b-E),R=Math.min(q,C);f+=R}}else{const g=_||12,q=m/g,b=D/g;for(let C=0;C<g;C++){const R=Math.max(0,b-E),k=Math.min(q,R);f+=k}}f=Math.round(f);const I=f-x;let w=0,X=0,P=0,S=null;return I>=0?X=I:(w=Math.abs(I),S=Oe(e,l,r),S!==null?P=Math.min(w,S):P=w),{householdIncome:n,familySize:o,federalPovertyLevel:s,incomeAsFplPercent:Math.round(l*10)/10,applicablePercentage:Math.round(h*1e4)/100,annualContributionAmount:Math.round(T),monthlyContribution:Math.round(L*100)/100,totalAnnualPremium:m,totalAnnualSlcsp:D,totalAnnualAptc:x,coverageMonths:_||12,annualPtcAllowed:f,netPtc:I,excessAptc:w,repaymentLimitation:S,excessAptcRepayment:P,additionalPtc:X,line11_annualContribution:Math.round(T),line24_totalPtcAllowed:f,line25_totalAptc:x,line26_netPtc:X,line27_excessAptc:w,line28_repaymentLimitation:S,line29_excessAptcRepayment:P}}function $e(t){const e=(t.drakeFormType||"").toLowerCase(),n=(t.documentType||"").toLowerCase();if(e==="1095_a"||e==="1095-a"||e==="form_1095_a"||e==="form_1095-a"||n==="1095_a"||n==="1095-a"||n==="form_1095_a"||n==="form_1095-a"||n==="1095a"||n.includes("1095-a")||n.includes("1095_a")||n.includes("1095"))return!0;const o=t.extractedAmounts;return!!(o&&(o.annualPremiumAmount||o.annualSlcspPremium||o.annualAdvancePtc))}function Ie(t,e,n,o,r){const a=r.filter(l=>$e(l)&&l.extractedAmounts);if(console.log("[FORM 8962] Checking documents for 1095-A..."),console.log("[FORM 8962] Total documents:",r.length),console.log("[FORM 8962] Found 1095-A documents:",a.length),a.length>0&&a.forEach((l,h)=>{console.log(`[FORM 8962] 1095-A #${h+1}:`,{drakeFormType:l.drakeFormType,documentType:l.documentType,extractedAmounts:l.extractedAmounts})}),a.length===0)return console.log("[FORM 8962] No 1095-A documents found with extracted amounts"),null;const s=a.map(l=>({annualPremium:l.extractedAmounts?.annualPremiumAmount||0,annualSlcsp:l.extractedAmounts?.annualSlcspPremium||0,annualAptc:l.extractedAmounts?.annualAdvancePtc||0,monthlyPremiums:l.extractedAmounts?.monthlyPremiums,monthlySlcsp:l.extractedAmounts?.monthlySlcsp,monthlyAptc:l.extractedAmounts?.monthlyAptc,coverageMonths:l.extractedAmounts?.coverageMonths}));return console.log("[FORM 8962] Extracted 1095-A data:",s),ve({taxYear:t,householdIncome:e,familySize:n,filingStatus:o,form1095AData:s})}const Ke=async t=>{try{const e=d.state.profile;e?.uid;const n=Date.now(),o={...t,id:pe(),businessId:d.getBusinessId(),createdAt:n,updatedAt:n,createdBy:e.uid,documentCount:0,verifiedDocumentCount:0},r={query:"addTaxPortal",params:{businessId:d.getBusinessId()},form:o};return u("Creating tax portal:",r),(await p(r))?.taxPortal||o}catch(e){throw u("Error creating tax portal:",e),new Error("Error al crear el portal de impuestos")}},Ve=async t=>{try{if(!d.state.user)throw new Error("Usuario no autenticado");let n={businessId:d.getBusinessId()};t&&t.trim();let s=((await p({query:"getTaxPortal",params:n}))?.data||[]).filter(l=>l.type==="document"||l.type==="checklist"?!1:l.firstName||l.lastName);if(!d.isAdmin()){const l=d.getAllowedStoreIds();s=s.filter(h=>h.storeId?l.includes(h.storeId):!0)}return s}catch(e){return u("Error getting tax portals:",e),[]}},Ze=async t=>{try{const e={query:"getTaxPortal",params:{businessId:d.getBusinessId(),id:t}},n=await p(e);return(n?.data?.taxPortal||n?.data||n?.taxPortal).filter(a=>a.id===t)?.[0]||null}catch(e){return u("Error getting tax portal:",e),null}},et=async(t,e)=>{try{const n={query:"updateTaxPortal",params:{businessId:d.getBusinessId(),id:t},form:{...e,updatedAt:Date.now()}};return(await p(n))?.taxPortal||{id:t,...e}}catch(n){throw u("Error updating tax portal:",n),new Error("Error al actualizar el portal de impuestos")}},tt=async t=>{try{const e={query:"deleteTaxPortal",params:{businessId:d.getBusinessId(),id:t}};await p(e)}catch(e){throw u("Error deleting tax portal:",e),new Error("Error al eliminar el portal de impuestos")}},Ue=()=>{const t=Date.now().toString(36),e=Math.random().toString(36).substring(2,12);return`TDR-${t}-${e}`.toUpperCase()},je=()=>Math.floor(1e5+Math.random()*9e5).toString(),Je=(t,e)=>{const n=`${window.location.origin}/#/tax-upload/${t}/${e}`;return`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(n)}`},nt=async(t,e)=>{try{const n=d.state.profile;n?.uid;const o=Date.now(),r=e.expirationDays||30,a=Ue(),s=pe(),l={id:s,title:e?.task?.title,taxPortalId:t?.id,recipientName:`${t?.firstName} ${t?.lastName}`.trim(),clientName:`${t?.firstName} ${t?.lastName}`.trim(),clientEmail:t?.email,recipientEmail:t?.email,clientPhone:t?.phone,accessToken:a,accessPin:je(),qrCodeUrl:Je(s,a),taxYear:e.taxYear,requestedDocuments:e.requestedDocuments||[...Ee],instructions:e.instructions,status:"pending",uploadedDocuments:[],createdAt:o,expiresAt:o+r*24*60*60*1e3,requestedBy:n.uid,requestedByName:n.displayName||n.email||"Unknown",businessId:d.getBusinessId()||"",storeId:t?.storeId,storeName:t?.storeName},h={query:"addTaxDocumentRequest",params:{businessId:d.getBusinessId()},form:l};return(await p(h))?.documentRequest||l}catch(n){throw u("Error creating document request:",n),new Error("Error al crear la solicitud de documentos")}},We=async(t,e,n)=>{try{const a=(await N({query:"getTaxDocumentRequestByToken",params:{accessToken:e,id:t,verifySignature:n}}))?.data;if(!a)return null;a.expiresAt<Date.now()&&a.status==="pending"&&(a.status="expired");try{await Ae(a.id,a.businessId)}catch{}return a}catch(o){return u("Error getting document request by token:",o),null}},ot=async(t,e)=>{try{const n=await We(t,e);if(!n||!n.taxPortalId)return null;const o={query:"getTaxPortalPublic",params:{id:n.taxPortalId,requestId:t,accessToken:e}},r=await N(o);return r?.data?.[0]||r?.data||null}catch(n){return u("Error getting tax portal by request:",n),null}},at=async(t,e,n)=>{try{const a=(await N({query:"getSignatureValidationByToken",params:{accessToken:e,id:t,verifySignature:n}}))?.data;if(!a)return null;a.expiresAt<Date.now()&&a.status==="pending"&&(a.status="expired");try{await Ae(a.id,a.businessId)}catch{}return a}catch(o){return u("Error getting document request by token:",o),null}},rt=async t=>{try{const o=(await p({query:"getTaxDocumentRequestByPin",params:{accessPin:t}}))?.documentRequest;if(!o)return null;o.expiresAt<Date.now()&&o.status==="pending"&&(o.status="expired");try{await Ae(o.id,o.businessId)}catch{}return o}catch(e){return u("Error getting document request by PIN:",e),null}},Ae=async(t,e)=>{const n={query:"updateTaxDocumentRequestLastAccess",params:{businessId:e,id:t},form:{lastAccessedAt:Date.now()}};await N(n)},st=async t=>{try{const e={query:"getTaxDocumentRequestsByRecipient",params:{businessId:d.getBusinessId(),recipientId:t}},n=await p(e);return n?.data?.data||n?.data||[]}catch(e){return u("Error getting document requests:",e),[]}},it=async t=>{try{if(!d.state.user)throw new Error("Usuario no autenticado");const n={query:"getTaxDocumentRequests",params:{businessId:d.getBusinessId()}},o=await p(n);let r=o?.data?.data||o?.data||[];if(!d.isAdmin()){const a=d.getAllowedStoreIds();r=r.filter(s=>s.storeId?a.includes(s.storeId):!0)}return t?.status,t?.taxYear,r.sort((a,s)=>s.createdAt-a.createdAt),r}catch(e){return u("Error getting document requests:",e),[]}},lt=async(t,e,n,o)=>{try{const s=(await p({query:"getTaxDocumentRequestById",params:{businessId:e,id:t}}))?.documentRequest;if(!s)throw new Error("Request not found");const l=s.requestedDocuments.map(m=>m.type===n?{...m,uploaded:!0,documentId:o}:m),h=l.filter(m=>m.required).every(m=>m.uploaded),T=l.some(m=>m.uploaded),L={query:"updateTaxDocumentRequest",params:{businessId:e,id:t},form:{requestedDocuments:l,uploadedDocuments:[...s.uploadedDocuments||[],o],status:h?"complete":T?"partial":"pending"}};await p(L)}catch(r){throw u("Error marking document uploaded:",r),r}},ct=async t=>{try{const e={query:"updateTaxDocumentRequest",params:{businessId:d.getBusinessId(),id:t},form:{status:"cancelled"}};await p(e)}catch(e){throw u("Error cancelling document request:",e),new Error("Error al cancelar la solicitud")}},dt=async t=>{try{const e={query:"deleteTaxDocumentRequest",params:{businessId:d.getBusinessId(),id:t}};await p(e)}catch(e){throw u("Error deleting document request:",e),new Error("Error al eliminar la solicitud")}},ut=async t=>{try{const e={query:"sendTaxDocumentRequestReminder",params:{businessId:d.getBusinessId(),id:t}},n=await p(e);n?.success&&await p({query:"updateTaxDocumentRequest",params:{businessId:d.getBusinessId(),id:t},form:{remindersSent:(n.remindersSent||0)+1}})}catch(e){throw u("Error sending reminder:",e),new Error("Error al enviar el recordatorio")}},mt=async(t,e,n,o)=>{try{const r={query:"markDocumentNotNeeded",params:{businessId:d.getBusinessId(),id:t,documentType:e,notNeeded:n,reason:o,markedBy:"accountant",markedAt:Date.now()}},a=await p(r);return{success:!0}}catch(r){return u("Error marking document as not needed:",r),{success:!1,error:"Error updating document status"}}},ht=t=>`${window.location.origin}/#/tax-upload/${t}`,gt=()=>`${window.location.origin}/#/tax-upload-pin`,pt=t=>{const e=Date.now(),n=t-e;if(n<=0)return"Expirado";const o=Math.floor(n/(24*60*60*1e3)),r=Math.floor(n%(24*60*60*1e3)/(60*60*1e3));return o>0?`${o} día${o>1?"s":""} restante${o>1?"s":""}`:`${r} hora${r>1?"s":""} restante${r>1?"s":""}`},At=t=>t.expiresAt<Date.now(),ft=t=>{const e=t.requestedDocuments.length,n=t.requestedDocuments.filter(o=>o.uploaded).length;return Math.round(n/e*100)},Ct=t=>t.requestedDocuments.filter(e=>e.required&&!e.uploaded),yt=async(t,e,n,o)=>{try{const r=await N({query:"updateTaxDocumentRequest",params:{requestId:t,id:t,accessToken:e,businessId:o},form:n});return{success:!0}}catch(r){return u("Error updating document request:",r),{success:!1,error:r.message}}};async function Tt(t,e,n,o){try{const r=await t.arrayBuffer(),a=Array.from(new Uint8Array(r)),s=await N({query:"uploadTaxDocument",params:{businessId:o?.businessId||d.getBusinessId()},form:{fileBuffer:a,fileName:t.name,mimeType:t.type,fileSize:t.size,taxPortalId:e,taxYear:n,businessId:o?.businessId||d.getBusinessId(),documentType:o?.documentType,tags:o?.tags,notes:o?.notes}});return s?.success&&s?.documentId?{success:!0,documentId:s.documentId,document:s.document}:{success:!1,error:s?.error||"Failed to upload document"}}catch(r){return u("Error uploading tax document:",r),{success:!1,error:r.message}}}const ze=t=>{const e={2024:{taxYear:2024,standardDeductions:{single:14600,married_jointly:29200,married_separately:14600,head_of_household:21900,qualifying_widow:29200},taxBrackets:{single:[{limit:11600,rate:.1,base:0,threshold:0},{limit:47150,rate:.12,base:1160,threshold:11600},{limit:100525,rate:.22,base:5426,threshold:47150},{limit:191950,rate:.24,base:17168.5,threshold:100525},{limit:243725,rate:.32,base:39110.5,threshold:191950},{limit:609350,rate:.35,base:55678.5,threshold:243725},{limit:1/0,rate:.37,base:183647.25,threshold:609350}],married_jointly:[{limit:23200,rate:.1,base:0,threshold:0},{limit:94300,rate:.12,base:2320,threshold:23200},{limit:201050,rate:.22,base:10852,threshold:94300},{limit:383900,rate:.24,base:34337,threshold:201050},{limit:487450,rate:.32,base:78221,threshold:383900},{limit:731200,rate:.35,base:111357,threshold:487450},{limit:1/0,rate:.37,base:196669.5,threshold:731200}],married_separately:[{limit:11600,rate:.1,base:0,threshold:0},{limit:47150,rate:.12,base:1160,threshold:11600},{limit:100525,rate:.22,base:5426,threshold:47150},{limit:191950,rate:.24,base:17168.5,threshold:100525},{limit:243725,rate:.32,base:39110.5,threshold:191950},{limit:365600,rate:.35,base:55678.5,threshold:243725},{limit:1/0,rate:.37,base:98334.75,threshold:365600}],head_of_household:[{limit:16550,rate:.1,base:0,threshold:0},{limit:63100,rate:.12,base:1655,threshold:16550},{limit:100500,rate:.22,base:7241,threshold:63100},{limit:191950,rate:.24,base:15469,threshold:100500},{limit:243700,rate:.32,base:37417,threshold:191950},{limit:609350,rate:.35,base:53977,threshold:243700},{limit:1/0,rate:.37,base:181954.5,threshold:609350}]},saltCap:1e4,saltCapMFS:5e3,additionalDeduction65Plus:{single:1950,married:1550},eitcBrackets:{0:{maxCredit:632,singleLimit:18591,mfjLimit:25511},1:{maxCredit:4213,singleLimit:49084,mfjLimit:56004},2:{maxCredit:6960,singleLimit:55768,mfjLimit:62688},3:{maxCredit:7830,singleLimit:59899,mfjLimit:66819}},childTaxCredit:{amountPerChild:2e3,maxRefundablePerChild:1700,phaseOutThresholdSingle:2e5,phaseOutThresholdMFJ:4e5}},2025:{taxYear:2025,standardDeductions:{single:15750,married_jointly:31500,married_separately:15750,head_of_household:23625,qualifying_widow:31500},taxBrackets:{single:[{limit:11925,rate:.1,base:0,threshold:0},{limit:48475,rate:.12,base:1192.5,threshold:11925},{limit:103350,rate:.22,base:5578.5,threshold:48475},{limit:197300,rate:.24,base:17651,threshold:103350},{limit:250525,rate:.32,base:40199,threshold:197300},{limit:626350,rate:.35,base:57231,threshold:250525},{limit:1/0,rate:.37,base:188769.75,threshold:626350}],married_jointly:[{limit:23850,rate:.1,base:0,threshold:0},{limit:96950,rate:.12,base:2385,threshold:23850},{limit:206700,rate:.22,base:11157,threshold:96950},{limit:394600,rate:.24,base:35302,threshold:206700},{limit:501050,rate:.32,base:80398,threshold:394600},{limit:751600,rate:.35,base:114462,threshold:501050},{limit:1/0,rate:.37,base:202154.5,threshold:751600}],married_separately:[{limit:11925,rate:.1,base:0,threshold:0},{limit:48475,rate:.12,base:1192.5,threshold:11925},{limit:103350,rate:.22,base:5578.5,threshold:48475},{limit:197300,rate:.24,base:17651,threshold:103350},{limit:250525,rate:.32,base:40199,threshold:197300},{limit:375800,rate:.35,base:57231,threshold:250525},{limit:1/0,rate:.37,base:101077.25,threshold:375800}],head_of_household:[{limit:17e3,rate:.1,base:0,threshold:0},{limit:64850,rate:.12,base:1700,threshold:17e3},{limit:103350,rate:.22,base:7442,threshold:64850},{limit:197300,rate:.24,base:15912,threshold:103350},{limit:250500,rate:.32,base:38460,threshold:197300},{limit:626350,rate:.35,base:55484,threshold:250500},{limit:1/0,rate:.37,base:187032,threshold:626350}]},saltCap:1e4,saltCapMFS:5e3,additionalDeduction65Plus:{single:2e3,married:1600},eitcBrackets:{0:{maxCredit:649,singleLimit:19104,mfjLimit:26214},1:{maxCredit:4328,singleLimit:50434,mfjLimit:57554},2:{maxCredit:7152,singleLimit:57310,mfjLimit:64430},3:{maxCredit:8046,singleLimit:61555,mfjLimit:68675}},childTaxCredit:{amountPerChild:2e3,maxRefundablePerChild:1700,phaseOutThresholdSingle:2e5,phaseOutThresholdMFJ:4e5}}};return e[t]||e[2025]},Ye={single:"Single",married_filing_jointly:"Married Filing Jointly",married_jointly:"Married Filing Jointly",married_filing_separately:"Married Filing Separately",married_separate:"Married Filing Separately",head_of_household:"Head of Household",head_household:"Head of Household",qualifying_widow:"Qualifying Surviving Spouse"},Qe=t=>({married_jointly:"married_jointly",married_filing_jointly:"married_jointly",married_separate:"married_separately",married_filing_separately:"married_separately",head_household:"head_of_household",head_of_household:"head_of_household",single:"single",qualifying_widow:"qualifying_widow"})[t]||"single",bt=async(t,e,n,o,r)=>{console.log("[TAX CALC] ===== TAX CALCULATION STARTED ====="),console.log("[TAX CALC] Client:",JSON.stringify({id:t,name:`${o.firstName} ${o.lastName}`,filingStatus:o.filingStatus,taxYear:e,dependentsCount:o.dependents?.length||0})),console.log("[TAX CALC] Documents count:",n.length);const a=ze(e),s=Qe(o.filingStatus||"single"),l=s==="married_separately";console.log("[TAX CALC] Filing status:",s),console.log("[TAX CALC] Tax year constants:",JSON.stringify({standardDeductions:a.standardDeductions,saltCap:a.saltCap,saltCapMFS:a.saltCapMFS}));let h=0,T=0,L=0,m=0,D=0,x=0,_=0,f=0,E=0,I=0,w=0,X=0,P=0,S=0,g=0,q=0;console.log("[TAX CALC] --- Processing Documents ---"),n.forEach((i,y)=>{if(console.log(`[TAX CALC] Doc ${y+1}: type=${i.drakeFormType||i.documentType} | verified=${i.verified} | hasAmounts=${!!i.extractedAmounts} | file=${i.originalFileName}`),i.verified&&i.extractedAmounts){const c=i.extractedAmounts;console.log(`[TAX CALC] Doc ${y+1} extractedAmounts:`,JSON.stringify(c)),c.wages&&(h+=c.wages),c.interestIncome&&(L+=c.interestIncome),c.ordinaryDividends&&(m+=c.ordinaryDividends),c.nonEmployeeCompensation&&(D+=c.nonEmployeeCompensation),c.rents&&(x+=c.rents),c.royalties&&(_+=c.royalties),c.otherIncome&&(f+=c.otherIncome),c.federalTaxWithheld&&(E+=c.federalTaxWithheld),c.federalTaxWithheld1099&&(I+=c.federalTaxWithheld1099),c.stateTaxWithheld&&(w+=c.stateTaxWithheld),c.localTaxWithheld&&(X+=c.localTaxWithheld),c.propertyTaxes&&(P+=c.propertyTaxes),c.mortgageInterest&&(S+=c.mortgageInterest),c.pointsPaid&&(g+=c.pointsPaid),c.mortgageInsurancePremiums&&(q+=c.mortgageInsurancePremiums)}});const b=h+T,C=D+x+_+f,R=b+L+m+C,k=E+I;console.log("[TAX CALC] --- Income Summary ---"),console.log("[TAX CALC] Line 1a (Wages):",h),console.log("[TAX CALC] Line 1h (Other earned):",T),console.log("[TAX CALC] Line 1z (Total wages):",b),console.log("[TAX CALC] Line 2b (Taxable interest):",L),console.log("[TAX CALC] Line 3b (Ordinary dividends):",m),console.log("[TAX CALC] Line 8 breakdown:",JSON.stringify({business:D,rental:x,royalties:_,other:f})),console.log("[TAX CALC] Line 8 (Other income total):",C),console.log("[TAX CALC] Line 9 (TOTAL INCOME):",R),console.log("[TAX CALC] Line 25a (W-2 withholding):",E),console.log("[TAX CALC] Line 25b (1099 withholding):",I),console.log("[TAX CALC] Line 25d (Total withholding):",k);const J=a.standardDeductions[s]||a.standardDeductions.single,fe=l?a.saltCapMFS:a.saltCap,Ce=w+X+P,H=Math.min(Ce,fe),K=S+g+q,ye=0,W=H+K+ye,V=W>J,Z=V?W:J,ee=r?.qbid||0,te=r?.schedule1ADeductions||0,ne=Z+ee+te,oe=0,M=R-oe,z=Math.max(0,M-ne);console.log("[TAX CALC] --- Deductions ---"),console.log("[TAX CALC] SALT breakdown:",JSON.stringify({state:w,local:X,property:P,total:Ce})),console.log("[TAX CALC] SALT cap:",fe),console.log("[TAX CALC] SALT deduction (capped):",H),console.log("[TAX CALC] Mortgage interest:",K),console.log("[TAX CALC] Itemized total:",W),console.log("[TAX CALC] Standard deduction:",J),console.log("[TAX CALC] Line 12e (Std/Itemized):",V?"ITEMIZED":"STANDARD","=",Z),console.log("[TAX CALC] Line 13a (QBID):",ee),console.log("[TAX CALC] Line 13b (Schedule 1-A):",te),console.log("[TAX CALC] Line 14 (Total deductions):",ne),console.log("[TAX CALC] Line 10 (Adjustments):",oe),console.log("[TAX CALC] Line 11 (AGI):",M),console.log("[TAX CALC] Line 15 (TAXABLE INCOME):",z);let O;s==="married_jointly"||s==="qualifying_widow"?O=a.taxBrackets.married_jointly:s==="head_of_household"?O=a.taxBrackets.head_of_household:s==="married_separately"?O=a.taxBrackets.married_separately:O=a.taxBrackets.single;let B=0,ae="",re=0;for(const i of O)if(z<=i.limit){B=i.base+(z-i.threshold)*i.rate,re=i.rate,ae=`${(i.rate*100).toFixed(0)}% bracket ($${i.threshold.toLocaleString()} - $${i.limit===1/0?"∞":i.limit.toLocaleString()})`;break}const se=1+(s==="married_jointly"?1:0)+(o.dependents?.length||0);let A=Ie(e,M,se,s,n);if(!A&&o.taxStrategy?.otherIncome?.healthInsuranceMarketplace){const i=o.taxStrategy.otherIncome.healthInsuranceMarketplace;if(i.hasMarketplaceCoverage&&i.coverageMonths>0){console.log("[TAX CALC] No 1095-A document found, using Strategy health insurance marketplace data"),console.log("[TAX CALC] Marketplace data:",JSON.stringify(i));const y={drakeFormType:"1095_a",documentType:"1095_a",extractedAmounts:{annualPremiumAmount:i.monthlyPremium*i.coverageMonths,annualSlcspPremium:i.monthlySlcsp*i.coverageMonths,annualAdvancePtc:i.monthlyAptc*i.coverageMonths,coverageMonths:i.coverageMonths}};A=Ie(e,M,se,s,[y])}}A&&(console.log("[TAX CALC] --- Form 8962 Premium Tax Credit ---"),console.log("[TAX CALC] Family size:",se),console.log("[TAX CALC] Income as % FPL:",A.incomeAsFplPercent+"%"),console.log("[TAX CALC] Applicable %:",A.applicablePercentage+"%"),console.log("[TAX CALC] Annual PTC allowed:",A.annualPtcAllowed),console.log("[TAX CALC] Total APTC received:",A.totalAnnualAptc),console.log("[TAX CALC] Excess APTC:",A.excessAptc),console.log("[TAX CALC] Repayment limitation:",A.repaymentLimitation),console.log("[TAX CALC] Line 29 (Excess repayment):",A.excessAptcRepayment),console.log("[TAX CALC] Additional PTC credit:",A.additionalPtc));const we=r?.schedule2Tax||0,De=A?.excessAptcRepayment||0,ie=we+De,le=B+ie;console.log("[TAX CALC] --- Tax Calculation ---"),console.log("[TAX CALC] Brackets used for:",s),console.log("[TAX CALC] Bracket:",ae),console.log("[TAX CALC] Line 16 (Tax from brackets):",B),console.log("[TAX CALC] Line 17 (Schedule 2 taxes):",ie),console.log("[TAX CALC] Line 18 (Total tax before credits):",le),console.log("[TAX CALC] Marginal rate:",(re*100).toFixed(0)+"%");const Pe=["son","daughter","stepson","stepdaughter","foster_child","grandchild"],ce=new Date(e,11,31),Y=(o.dependents||[]).filter(i=>{if(!Pe.includes(i.relationship))return!1;if(i.dateOfBirth){const y=new Date(i.dateOfBirth);return ce.getFullYear()-y.getFullYear()-(ce<new Date(ce.getFullYear(),y.getMonth(),y.getDate())?1:0)<17}return!0});console.log("[TAX CALC] --- Credits Calculation ---"),console.log("[TAX CALC] Total dependents:",o.dependents?.length||0),console.log("[TAX CALC] Qualifying children (under 17):",Y.length),console.log("[TAX CALC] Dependents detail:",JSON.stringify(o.dependents?.map(i=>({name:`${i.firstName} ${i.lastName}`,relationship:i.relationship,dob:i.dateOfBirth}))));const v=a.childTaxCredit,Se=v.amountPerChild,de=s==="married_jointly"?v.phaseOutThresholdMFJ:v.phaseOutThresholdSingle;let $=Y.length*Se;if(M>de){const i=M-de,y=Math.ceil(i/1e3)*50;$=Math.max(0,$-y),console.log("[TAX CALC] CTC phase-out: AGI",M,"> threshold",de,", reduction:",y)}const U=Math.min($,le),Q=Math.min(Y.length*v.maxRefundablePerChild,$-U);console.log("[TAX CALC] Child Tax Credit constants:",JSON.stringify(v)),console.log("[TAX CALC] Child Tax Credit (before limit):",$),console.log("[TAX CALC] Non-refundable CTC (limited to Line 18 tax):",U),console.log("[TAX CALC] Additional Child Tax Credit (refundable):",Q);const ue=b,qe=s==="married_jointly",Te=Math.min(Y.length,3),G=a.eitcBrackets[Te],be=qe?G.mfjLimit:G.singleLimit;let j=0;ue>0&&ue<=be&&(j=G.maxCredit),console.log("[TAX CALC] EITC constants for",e,":",JSON.stringify(a.eitcBrackets)),console.log("[TAX CALC] Earned income for EIC:",ue),console.log("[TAX CALC] EIC bracket:",Te,"children, limit:",be,"max:",G.maxCredit),console.log("[TAX CALC] EIC credit:",j);const me=U,he=Math.max(0,B-me),Me=Q+j,ge=k+Me,F=ge-he;console.log("[TAX CALC] --- Final Calculation ---"),console.log("[TAX CALC] Line 16 (Tax before credits):",B),console.log("[TAX CALC] Line 19 (Child Tax Credit):",U),console.log("[TAX CALC] Line 21 (Total non-refundable credits):",me),console.log("[TAX CALC] Line 24 (Total tax after credits):",he),console.log("[TAX CALC] Line 25d (Withholding):",k),console.log("[TAX CALC] Line 27 (EIC - refundable):",j),console.log("[TAX CALC] Line 28 (ACTC - refundable):",Q),console.log("[TAX CALC] Line 33 (Total payments + refundable credits):",ge),console.log("[TAX CALC] RESULT:",F>0?`REFUND $${F.toFixed(2)}`:`OWED $${Math.abs(F).toFixed(2)}`);const Le={id:pe(),taxPortalId:t,taxYear:e,filingStatus:s,filingStatusLabel:Ye[o.filingStatus||"single"]||"Single",calculatedAt:Date.now(),line1a_wages:h,line1h_otherEarnedIncome:T,line1z_totalWages:b,line2b_taxableInterest:L,line3b_ordinaryDividends:m,line8_otherIncome:C,line8_breakdown:{businessIncome:D,rentalIncome:x,royalties:_,other:f},line9_totalIncome:R,line10_adjustments:oe,line11_agi:M,line12a_standardDeduction:J,line12b_itemizedDeductions:W,line12b_breakdown:{saltDeduction:H,mortgageInterest:K,charitableContributions:ye},line12_deductionUsed:V?"itemized":"standard",line12_deductionAmount:Z,line13a_qbid:ee,line13b_schedule1ADeductions:te,line14_totalDeductions:ne,line15_taxableIncome:z,line16_tax:B,line16_bracketUsed:ae,line16_marginalRate:re,line17_schedule2Tax:ie,line18_totalTaxBeforeCredits:le,line19_childTaxCredit:U,line21_totalCredits:me,line24_totalTax:he,line25a_w2Withholding:E,line25b_1099Withholding:I,line25d_totalWithholding:k,line27_eic:j,line28_actc:Q,line33_totalPayments:ge,line34_refund:F>0?F:0,line37_amountOwed:F<0?Math.abs(F):0,form8962:A||void 0};return console.log("[TAX CALC] ===== FULL RESULT ====="),console.log("[TAX CALC]",JSON.stringify(Le,null,2)),console.log("[TAX CALC] ===== TAX CALCULATION COMPLETE ====="),Le};export{ft as a,ht as b,gt as c,nt as d,ct as e,pt as f,st as g,dt as h,At as i,Ve as j,it as k,Ke as l,tt as m,mt as n,bt as o,Ze as p,We as q,Ct as r,ut as s,yt as t,et as u,Tt as v,lt as w,rt as x,ot as y,at as z};
