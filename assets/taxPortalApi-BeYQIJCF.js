import{aB as m,g as a,O as c,P as g}from"./index-DsjFW37z.js";import{a as w}from"./drakeTypes-DcjcYEfx.js";const x=async e=>{try{const t=a.state.profile;t?.uid;const r=Date.now(),s={...e,id:g(),businessId:a.getBusinessId(),createdAt:r,updatedAt:r,createdBy:t.uid,documentCount:0,verifiedDocumentCount:0},o={query:"addTaxPortal",params:{businessId:a.getBusinessId()},form:s};return console.log("Creating tax portal:",o),(await c(o))?.taxPortal||s}catch(t){throw console.error("Error creating tax portal:",t),new Error("Error al crear el portal de impuestos")}},E=async e=>{try{if(!a.state.user)throw new Error("Usuario no autenticado");let r={businessId:a.getBusinessId()};e&&e.trim();let u=((await c({query:"getTaxPortal",params:r}))?.data||[]).filter(d=>d.type==="document"||d.type==="checklist"?!1:d.firstName||d.lastName);if(!a.isAdmin()){const d=a.getAllowedStoreIds();u=u.filter(l=>l.storeId?d.includes(l.storeId):!0)}return u}catch(t){return console.error("Error getting tax portals:",t),[]}},R=async e=>{try{const t={query:"getTaxPortal",params:{businessId:a.getBusinessId(),id:e}},r=await c(t);return(r?.data?.taxPortal||r?.data||r?.taxPortal).filter(n=>n.id===e)?.[0]||null}catch(t){return console.error("Error getting tax portal:",t),null}},T=async(e,t)=>{try{const r={query:"updateTaxPortal",params:{businessId:a.getBusinessId(),id:e},form:{...t,updatedAt:Date.now()}};return(await c(r))?.taxPortal||{id:e,...t}}catch(r){throw console.error("Error updating tax portal:",r),new Error("Error al actualizar el portal de impuestos")}},B=async e=>{try{const t={query:"deleteTaxPortal",params:{businessId:a.getBusinessId(),id:e}};await c(t)}catch(t){throw console.error("Error deleting tax portal:",t),new Error("Error al eliminar el portal de impuestos")}},f=()=>{const e=Date.now().toString(36),t=Math.random().toString(36).substring(2,12);return`TDR-${e}-${t}`.toUpperCase()},D=()=>Math.floor(1e5+Math.random()*9e5).toString(),I=(e,t)=>{const r=`${window.location.origin}/#/tax-upload/${e}/${t}`;return`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(r)}`},A=async(e,t)=>{try{const r=a.state.profile;r?.uid;const s=Date.now(),o=t.expirationDays||30,n=f(),u=g();console.log(e);const d={id:u,title:t?.task?.title,taxPortalId:e?.id,recipientName:`${e?.firstName} ${e?.lastName}`.trim(),clientName:`${e?.firstName} ${e?.lastName}`.trim(),clientEmail:e?.email,recipientEmail:e?.email,clientPhone:e?.phone,accessToken:n,accessPin:D(),qrCodeUrl:I(u,n),taxYear:t.taxYear,requestedDocuments:t.requestedDocuments||[...w],instructions:t.instructions,status:"pending",uploadedDocuments:[],createdAt:s,expiresAt:s+o*24*60*60*1e3,requestedBy:r.uid,requestedByName:r.displayName||r.email||"Unknown",businessId:a.getBusinessId()||"",storeId:e?.storeId,storeName:e?.storeName},l={query:"addTaxDocumentRequest",params:{businessId:a.getBusinessId()},form:d};return console.log("Creating document request:",l),(await c(l))?.documentRequest||d}catch(r){throw console.error("Error creating document request:",r),new Error("Error al crear la solicitud de documentos")}},U=async(e,t,r)=>{try{const n=(await m({query:"getTaxDocumentRequestByToken",params:{accessToken:t,id:e,verifySignature:r}}))?.data;if(!n)return null;n.expiresAt<Date.now()&&n.status==="pending"&&(n.status="expired");try{await p(n.id,n.businessId)}catch{}return n}catch(s){return console.error("Error getting document request by token:",s),null}},S=async(e,t,r)=>{try{const n=(await m({query:"getSignatureValidationByToken",params:{accessToken:t,id:e,verifySignature:r}}))?.data;if(!n)return null;n.expiresAt<Date.now()&&n.status==="pending"&&(n.status="expired");try{await p(n.id,n.businessId)}catch{}return n}catch(s){return console.error("Error getting document request by token:",s),null}},P=async e=>{try{const s=(await c({query:"getTaxDocumentRequestByPin",params:{accessPin:e}}))?.documentRequest;if(!s)return null;s.expiresAt<Date.now()&&s.status==="pending"&&(s.status="expired");try{await p(s.id,s.businessId)}catch{}return s}catch(t){return console.error("Error getting document request by PIN:",t),null}},p=async(e,t)=>{const r={query:"updateTaxDocumentRequestLastAccess",params:{businessId:t,id:e},form:{lastAccessedAt:Date.now()}};await m(r)},$=async e=>{try{const t={query:"getTaxDocumentRequestsByRecipient",params:{businessId:a.getBusinessId(),recipientId:e}},r=await c(t);return r?.data?.data||r?.data||[]}catch(t){return console.error("Error getting document requests:",t),[]}},N=async e=>{try{if(!a.state.user)throw new Error("Usuario no autenticado");const r={query:"getTaxDocumentRequests",params:{businessId:a.getBusinessId()}},s=await c(r);let o=s?.data?.data||s?.data||[];if(!a.isAdmin()){const n=a.getAllowedStoreIds();o=o.filter(u=>u.storeId?n.includes(u.storeId):!0)}return e?.status,e?.taxYear,o.sort((n,u)=>u.createdAt-n.createdAt),o}catch(t){return console.error("Error getting document requests:",t),[]}},k=async(e,t,r,s)=>{try{const u=(await c({query:"getTaxDocumentRequestById",params:{businessId:t,id:e}}))?.documentRequest;if(!u)throw new Error("Request not found");const d=u.requestedDocuments.map(i=>i.type===r?{...i,uploaded:!0,documentId:s}:i),l=d.filter(i=>i.required).every(i=>i.uploaded),y=d.some(i=>i.uploaded),q={query:"updateTaxDocumentRequest",params:{businessId:t,id:e},form:{requestedDocuments:d,uploadedDocuments:[...u.uploadedDocuments||[],s],status:l?"complete":y?"partial":"pending"}};await c(q)}catch(o){throw console.error("Error marking document uploaded:",o),o}},C=async e=>{try{const t={query:"updateTaxDocumentRequest",params:{businessId:a.getBusinessId(),id:e},form:{status:"cancelled"}};await c(t)}catch(t){throw console.error("Error cancelling document request:",t),new Error("Error al cancelar la solicitud")}},v=async e=>{try{const t={query:"deleteTaxDocumentRequest",params:{businessId:a.getBusinessId(),id:e}};await c(t)}catch(t){throw console.error("Error deleting document request:",t),new Error("Error al eliminar la solicitud")}},M=async e=>{try{const t={query:"sendTaxDocumentRequestReminder",params:{businessId:a.getBusinessId(),id:e}},r=await c(t);r?.success&&await c({query:"updateTaxDocumentRequest",params:{businessId:a.getBusinessId(),id:e},form:{remindersSent:(r.remindersSent||0)+1}})}catch(t){throw console.error("Error sending reminder:",t),new Error("Error al enviar el recordatorio")}},L=e=>`${window.location.origin}/#/tax-upload/${e}`,z=()=>`${window.location.origin}/#/tax-upload-pin`,Q=e=>{const t=Date.now(),r=e-t;if(r<=0)return"Expirado";const s=Math.floor(r/(24*60*60*1e3)),o=Math.floor(r%(24*60*60*1e3)/(60*60*1e3));return s>0?`${s} dÃ­a${s>1?"s":""} restante${s>1?"s":""}`:`${o} hora${o>1?"s":""} restante${o>1?"s":""}`},Y=e=>e.expiresAt<Date.now(),_=e=>{const t=e.requestedDocuments.length,r=e.requestedDocuments.filter(s=>s.uploaded).length;return Math.round(r/t*100)},F=e=>e.requestedDocuments.filter(t=>t.required&&!t.uploaded),O=async(e,t,r,s)=>{try{const o=await m({query:"updateTaxDocumentRequest",params:{requestId:e,id:e,accessToken:t,businessId:s},form:r});return{success:!0}}catch(o){return console.error("Error updating document request:",o),{success:!1,error:o.message}}};async function j(e,t,r,s){try{const o=await e.arrayBuffer(),n=Array.from(new Uint8Array(o)),u=await m({query:"uploadTaxDocument",params:{businessId:s?.businessId||a.getBusinessId()},form:{fileBuffer:n,fileName:e.name,mimeType:e.type,fileSize:e.size,taxPortalId:t,taxYear:r,businessId:s?.businessId||a.getBusinessId(),documentType:s?.documentType,tags:s?.tags,notes:s?.notes}});return u?.success&&u?.documentId?{success:!0,documentId:u.documentId,document:u.document}:{success:!1,error:u?.error||"Failed to upload document"}}catch(o){return console.error("Error uploading tax document:",o),{success:!1,error:o.message}}}export{_ as a,L as b,z as c,A as d,C as e,Q as f,$ as g,v as h,Y as i,E as j,N as k,x as l,B as m,R as n,U as o,F as p,O as q,j as r,M as s,k as t,T as u,P as v,S as w};
