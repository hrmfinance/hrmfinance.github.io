import{aG as g,e as l,h as d,P as c,Q as P}from"./index-BatYe0cj.js";import{a as X}from"./drakeTypes-DcjcYEfx.js";const le=async t=>{try{const e=d.state.profile;e?.uid;const r=Date.now(),a={...t,id:P(),businessId:d.getBusinessId(),createdAt:r,updatedAt:r,createdBy:e.uid,documentCount:0,verifiedDocumentCount:0},s={query:"addTaxPortal",params:{businessId:d.getBusinessId()},form:a};return l("Creating tax portal:",s),(await c(s))?.taxPortal||a}catch(e){throw l("Error creating tax portal:",e),new Error("Error al crear el portal de impuestos")}},ue=async t=>{try{if(!d.state.user)throw new Error("Usuario no autenticado");let r={businessId:d.getBusinessId()};t&&t.trim();let i=((await c({query:"getTaxPortal",params:r}))?.data||[]).filter(u=>u.type==="document"||u.type==="checklist"?!1:u.firstName||u.lastName);if(!d.isAdmin()){const u=d.getAllowedStoreIds();i=i.filter(y=>y.storeId?u.includes(y.storeId):!0)}return i}catch(e){return l("Error getting tax portals:",e),[]}},ce=async t=>{try{const e={query:"getTaxPortal",params:{businessId:d.getBusinessId(),id:t}},r=await c(e);return(r?.data?.taxPortal||r?.data||r?.taxPortal).filter(n=>n.id===t)?.[0]||null}catch(e){return l("Error getting tax portal:",e),null}},me=async(t,e)=>{try{const r={query:"updateTaxPortal",params:{businessId:d.getBusinessId(),id:t},form:{...e,updatedAt:Date.now()}};return(await c(r))?.taxPortal||{id:t,...e}}catch(r){throw l("Error updating tax portal:",r),new Error("Error al actualizar el portal de impuestos")}},he=async t=>{try{const e={query:"deleteTaxPortal",params:{businessId:d.getBusinessId(),id:t}};await c(e)}catch(e){throw l("Error deleting tax portal:",e),new Error("Error al eliminar el portal de impuestos")}},Z=()=>{const t=Date.now().toString(36),e=Math.random().toString(36).substring(2,12);return`TDR-${t}-${e}`.toUpperCase()},ee=()=>Math.floor(1e5+Math.random()*9e5).toString(),te=(t,e)=>{const r=`${window.location.origin}/#/tax-upload/${t}/${e}`;return`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(r)}`},ye=async(t,e)=>{try{const r=d.state.profile;r?.uid;const a=Date.now(),s=e.expirationDays||30,n=Z(),i=P(),u={id:i,title:e?.task?.title,taxPortalId:t?.id,recipientName:`${t?.firstName} ${t?.lastName}`.trim(),clientName:`${t?.firstName} ${t?.lastName}`.trim(),clientEmail:t?.email,recipientEmail:t?.email,clientPhone:t?.phone,accessToken:n,accessPin:ee(),qrCodeUrl:te(i,n),taxYear:e.taxYear,requestedDocuments:e.requestedDocuments||[...X],instructions:e.instructions,status:"pending",uploadedDocuments:[],createdAt:a,expiresAt:a+s*24*60*60*1e3,requestedBy:r.uid,requestedByName:r.displayName||r.email||"Unknown",businessId:d.getBusinessId()||"",storeId:t?.storeId,storeName:t?.storeName},y={query:"addTaxDocumentRequest",params:{businessId:d.getBusinessId()},form:u};return(await c(y))?.documentRequest||u}catch(r){throw l("Error creating document request:",r),new Error("Error al crear la solicitud de documentos")}},re=async(t,e,r)=>{try{const n=(await g({query:"getTaxDocumentRequestByToken",params:{accessToken:e,id:t,verifySignature:r}}))?.data;if(!n)return null;n.expiresAt<Date.now()&&n.status==="pending"&&(n.status="expired");try{await k(n.id,n.businessId)}catch{}return n}catch(a){return l("Error getting document request by token:",a),null}},pe=async(t,e)=>{try{const r=await re(t,e);if(!r||!r.taxPortalId)return null;const a={query:"getTaxPortalPublic",params:{id:r.taxPortalId,requestId:t,accessToken:e}},s=await g(a);return s?.data?.[0]||s?.data||null}catch(r){return l("Error getting tax portal by request:",r),null}},ge=async(t,e,r)=>{try{const n=(await g({query:"getSignatureValidationByToken",params:{accessToken:e,id:t,verifySignature:r}}))?.data;if(!n)return null;n.expiresAt<Date.now()&&n.status==="pending"&&(n.status="expired");try{await k(n.id,n.businessId)}catch{}return n}catch(a){return l("Error getting document request by token:",a),null}},fe=async t=>{try{const a=(await c({query:"getTaxDocumentRequestByPin",params:{accessPin:t}}))?.documentRequest;if(!a)return null;a.expiresAt<Date.now()&&a.status==="pending"&&(a.status="expired");try{await k(a.id,a.businessId)}catch{}return a}catch(e){return l("Error getting document request by PIN:",e),null}},k=async(t,e)=>{const r={query:"updateTaxDocumentRequestLastAccess",params:{businessId:e,id:t},form:{lastAccessedAt:Date.now()}};await g(r)},be=async t=>{try{const e={query:"getTaxDocumentRequestsByRecipient",params:{businessId:d.getBusinessId(),recipientId:t}},r=await c(e);return r?.data?.data||r?.data||[]}catch(e){return l("Error getting document requests:",e),[]}},we=async t=>{try{if(!d.state.user)throw new Error("Usuario no autenticado");const r={query:"getTaxDocumentRequests",params:{businessId:d.getBusinessId()}},a=await c(r);let s=a?.data?.data||a?.data||[];if(!d.isAdmin()){const n=d.getAllowedStoreIds();s=s.filter(i=>i.storeId?n.includes(i.storeId):!0)}return t?.status,t?.taxYear,s.sort((n,i)=>i.createdAt-n.createdAt),s}catch(e){return l("Error getting document requests:",e),[]}},_e=async(t,e,r,a)=>{try{const i=(await c({query:"getTaxDocumentRequestById",params:{businessId:e,id:t}}))?.documentRequest;if(!i)throw new Error("Request not found");const u=i.requestedDocuments.map(m=>m.type===r?{...m,uploaded:!0,documentId:a}:m),y=u.filter(m=>m.required).every(m=>m.uploaded),p=u.some(m=>m.uploaded),f={query:"updateTaxDocumentRequest",params:{businessId:e,id:t},form:{requestedDocuments:u,uploadedDocuments:[...i.uploadedDocuments||[],a],status:y?"complete":p?"partial":"pending"}};await c(f)}catch(s){throw l("Error marking document uploaded:",s),s}},Ie=async t=>{try{const e={query:"updateTaxDocumentRequest",params:{businessId:d.getBusinessId(),id:t},form:{status:"cancelled"}};await c(e)}catch(e){throw l("Error cancelling document request:",e),new Error("Error al cancelar la solicitud")}},qe=async t=>{try{const e={query:"deleteTaxDocumentRequest",params:{businessId:d.getBusinessId(),id:t}};await c(e)}catch(e){throw l("Error deleting document request:",e),new Error("Error al eliminar la solicitud")}},xe=async t=>{try{const e={query:"sendTaxDocumentRequestReminder",params:{businessId:d.getBusinessId(),id:t}},r=await c(e);r?.success&&await c({query:"updateTaxDocumentRequest",params:{businessId:d.getBusinessId(),id:t},form:{remindersSent:(r.remindersSent||0)+1}})}catch(e){throw l("Error sending reminder:",e),new Error("Error al enviar el recordatorio")}},De=async(t,e,r,a)=>{try{const s={query:"markDocumentNotNeeded",params:{businessId:d.getBusinessId(),id:t,documentType:e,notNeeded:r,reason:a,markedBy:"accountant",markedAt:Date.now()}},n=await c(s);return{success:!0}}catch(s){return l("Error marking document as not needed:",s),{success:!1,error:"Error updating document status"}}},Te=t=>`${window.location.origin}/#/tax-upload/${t}`,Ee=()=>`${window.location.origin}/#/tax-upload-pin`,Se=t=>{const e=Date.now(),r=t-e;if(r<=0)return"Expirado";const a=Math.floor(r/(24*60*60*1e3)),s=Math.floor(r%(24*60*60*1e3)/(60*60*1e3));return a>0?`${a} día${a>1?"s":""} restante${a>1?"s":""}`:`${s} hora${s>1?"s":""} restante${s>1?"s":""}`},Be=t=>t.expiresAt<Date.now(),Re=t=>{const e=t.requestedDocuments.length,r=t.requestedDocuments.filter(a=>a.uploaded).length;return Math.round(r/e*100)},Pe=t=>t.requestedDocuments.filter(e=>e.required&&!e.uploaded),ke=async(t,e,r,a)=>{try{const s=await g({query:"updateTaxDocumentRequest",params:{requestId:t,id:t,accessToken:e,businessId:a},form:r});return{success:!0}}catch(s){return l("Error updating document request:",s),{success:!1,error:s.message}}};async function Ae(t,e,r,a){try{const s=await t.arrayBuffer(),n=Array.from(new Uint8Array(s)),i=await g({query:"uploadTaxDocument",params:{businessId:a?.businessId||d.getBusinessId()},form:{fileBuffer:n,fileName:t.name,mimeType:t.type,fileSize:t.size,taxPortalId:e,taxYear:r,businessId:a?.businessId||d.getBusinessId(),documentType:a?.documentType,tags:a?.tags,notes:a?.notes}});return i?.success&&i?.documentId?{success:!0,documentId:i.documentId,document:i.document}:{success:!1,error:i?.error||"Failed to upload document"}}catch(s){return l("Error uploading tax document:",s),{success:!1,error:s.message}}}const ae=t=>{const e={2024:{taxYear:2024,standardDeductions:{single:14600,married_jointly:29200,married_separately:14600,head_of_household:21900,qualifying_widow:29200},taxBrackets:{single:[{limit:11600,rate:.1,base:0,threshold:0},{limit:47150,rate:.12,base:1160,threshold:11600},{limit:100525,rate:.22,base:5426,threshold:47150},{limit:191950,rate:.24,base:17168.5,threshold:100525},{limit:243725,rate:.32,base:39110.5,threshold:191950},{limit:609350,rate:.35,base:55678.5,threshold:243725},{limit:1/0,rate:.37,base:183647.25,threshold:609350}],married_jointly:[{limit:23200,rate:.1,base:0,threshold:0},{limit:94300,rate:.12,base:2320,threshold:23200},{limit:201050,rate:.22,base:10852,threshold:94300},{limit:383900,rate:.24,base:34337,threshold:201050},{limit:487450,rate:.32,base:78221,threshold:383900},{limit:731200,rate:.35,base:111357,threshold:487450},{limit:1/0,rate:.37,base:196669.5,threshold:731200}],married_separately:[{limit:11600,rate:.1,base:0,threshold:0},{limit:47150,rate:.12,base:1160,threshold:11600},{limit:100525,rate:.22,base:5426,threshold:47150},{limit:191950,rate:.24,base:17168.5,threshold:100525},{limit:243725,rate:.32,base:39110.5,threshold:191950},{limit:365600,rate:.35,base:55678.5,threshold:243725},{limit:1/0,rate:.37,base:98334.75,threshold:365600}],head_of_household:[{limit:16550,rate:.1,base:0,threshold:0},{limit:63100,rate:.12,base:1655,threshold:16550},{limit:100500,rate:.22,base:7241,threshold:63100},{limit:191950,rate:.24,base:15469,threshold:100500},{limit:243700,rate:.32,base:37417,threshold:191950},{limit:609350,rate:.35,base:53977,threshold:243700},{limit:1/0,rate:.37,base:181954.5,threshold:609350}]},saltCap:1e4,saltCapMFS:5e3,additionalDeduction65Plus:{single:1950,married:1550}},2025:{taxYear:2025,standardDeductions:{single:15e3,married_jointly:3e4,married_separately:15e3,head_of_household:22500,qualifying_widow:3e4},taxBrackets:{single:[{limit:11925,rate:.1,base:0,threshold:0},{limit:48475,rate:.12,base:1192.5,threshold:11925},{limit:103350,rate:.22,base:5578.5,threshold:48475},{limit:197300,rate:.24,base:17651,threshold:103350},{limit:250525,rate:.32,base:40199,threshold:197300},{limit:626350,rate:.35,base:57231,threshold:250525},{limit:1/0,rate:.37,base:188769.75,threshold:626350}],married_jointly:[{limit:23850,rate:.1,base:0,threshold:0},{limit:96950,rate:.12,base:2385,threshold:23850},{limit:206700,rate:.22,base:11157,threshold:96950},{limit:394600,rate:.24,base:35302,threshold:206700},{limit:501050,rate:.32,base:80398,threshold:394600},{limit:751600,rate:.35,base:114462,threshold:501050},{limit:1/0,rate:.37,base:202154.5,threshold:751600}],married_separately:[{limit:11925,rate:.1,base:0,threshold:0},{limit:48475,rate:.12,base:1192.5,threshold:11925},{limit:103350,rate:.22,base:5578.5,threshold:48475},{limit:197300,rate:.24,base:17651,threshold:103350},{limit:250525,rate:.32,base:40199,threshold:197300},{limit:375800,rate:.35,base:57231,threshold:250525},{limit:1/0,rate:.37,base:101077.25,threshold:375800}],head_of_household:[{limit:17e3,rate:.1,base:0,threshold:0},{limit:64850,rate:.12,base:1700,threshold:17e3},{limit:103350,rate:.22,base:7442,threshold:64850},{limit:197300,rate:.24,base:15912,threshold:103350},{limit:250500,rate:.32,base:38460,threshold:197300},{limit:626350,rate:.35,base:55484,threshold:250500},{limit:1/0,rate:.37,base:187032,threshold:626350}]},saltCap:1e4,saltCapMFS:5e3,additionalDeduction65Plus:{single:2e3,married:1600}}};return e[t]||e[2024]},se={single:"Single",married_filing_jointly:"Married Filing Jointly",married_jointly:"Married Filing Jointly",married_filing_separately:"Married Filing Separately",married_separate:"Married Filing Separately",head_of_household:"Head of Household",head_household:"Head of Household",qualifying_widow:"Qualifying Surviving Spouse"},ne=t=>({married_jointly:"married_jointly",married_filing_jointly:"married_jointly",married_separate:"married_separately",married_filing_separately:"married_separately",head_household:"head_of_household",head_of_household:"head_of_household",single:"single",qualifying_widow:"qualifying_widow"})[t]||"single",Ue=async(t,e,r,a)=>{const s=ae(e),n=ne(a.filingStatus||"single"),i=n==="married_separately";let u=0,y=0,p=0,f=0,m=0,I=0,q=0,x=0,D=0,T=0,A=0,U=0,$=0,M=0,N=0,C=0;r.forEach(h=>{if(h.verified&&h.extractedAmounts){const o=h.extractedAmounts;o.wages&&(u+=o.wages),o.interestIncome&&(p+=o.interestIncome),o.ordinaryDividends&&(f+=o.ordinaryDividends),o.nonEmployeeCompensation&&(m+=o.nonEmployeeCompensation),o.rents&&(I+=o.rents),o.royalties&&(q+=o.royalties),o.otherIncome&&(x+=o.otherIncome),o.federalTaxWithheld&&(D+=o.federalTaxWithheld),o.federalTaxWithheld1099&&(T+=o.federalTaxWithheld1099),o.stateTaxWithheld&&(A+=o.stateTaxWithheld),o.localTaxWithheld&&(U+=o.localTaxWithheld),o.propertyTaxes&&($+=o.propertyTaxes),o.mortgageInterest&&(M+=o.mortgageInterest),o.pointsPaid&&(N+=o.pointsPaid),o.mortgageInsurancePremiums&&(C+=o.mortgageInsurancePremiums)}});const v=u+y,j=m+I+q+x,L=v+p+f+j,E=D+T,S=s.standardDeductions[n]||s.standardDeductions.single,V=i?s.saltCapMFS:s.saltCap,K=A+U+$,F=Math.min(K,V),W=M+N+C,z=0,B=F+W+z,Q=B>S,H=Q?B:S,O=0,Y=L-O,R=Math.max(0,Y-H);let b;n==="married_jointly"||n==="qualifying_widow"?b=s.taxBrackets.married_jointly:n==="head_of_household"?b=s.taxBrackets.head_of_household:n==="married_separately"?b=s.taxBrackets.married_separately:b=s.taxBrackets.single;let w=0,G="",J=0;for(const h of b)if(R<=h.limit){w=h.base+(R-h.threshold)*h.rate,J=h.rate,G=`${(h.rate*100).toFixed(0)}% bracket ($${h.threshold.toLocaleString()} - $${h.limit===1/0?"∞":h.limit.toLocaleString()})`;break}const _=E-w;return{id:P(),taxPortalId:t,taxYear:e,filingStatus:n,filingStatusLabel:se[a.filingStatus||"single"]||"Single",calculatedAt:Date.now(),line1a_wages:u,line1h_otherEarnedIncome:y,line1z_totalWages:v,line2b_taxableInterest:p,line3b_ordinaryDividends:f,line8_otherIncome:j,line8_breakdown:{businessIncome:m,rentalIncome:I,royalties:q,other:x},line9_totalIncome:L,line10_adjustments:O,line11_agi:Y,line12a_standardDeduction:S,line12b_itemizedDeductions:B,line12b_breakdown:{saltDeduction:F,mortgageInterest:W,charitableContributions:z},line12_deductionUsed:Q?"itemized":"standard",line12_deductionAmount:H,line15_taxableIncome:R,line16_tax:w,line16_bracketUsed:G,line16_marginalRate:J,line24_totalTax:w,line25a_w2Withholding:D,line25b_1099Withholding:T,line25d_totalWithholding:E,line33_totalPayments:E,line34_refund:_>0?_:0,line37_amountOwed:_<0?Math.abs(_):0}};export{Re as a,Te as b,Ee as c,ye as d,Ie as e,Se as f,be as g,qe as h,Be as i,ue as j,we as k,le as l,he as m,De as n,Ue as o,ce as p,re as q,Pe as r,xe as s,ke as t,me as u,Ae as v,_e as w,fe as x,pe as y,ge as z};
