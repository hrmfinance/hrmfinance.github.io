import{e as t,aJ as U,h as u,P as A,Q as Ce}from"./index-D6-FjIa-.js";import{a as Fe}from"./drakeTypes-Bvs2kMQX.js";const we={2023:{1:14580,2:19720,3:24860,4:3e4,5:35140,6:40280,7:45420,8:50560},2024:{1:15060,2:20440,3:25820,4:31200,5:36580,6:41960,7:47340,8:52720},2025:{1:15650,2:21150,3:26650,4:32150,5:37650,6:43150,7:48650,8:54150},2026:{1:16e3,2:21600,3:27200,4:32800,5:38400,6:44e3,7:49600,8:55200}},Pe={2023:5140,2024:5380,2025:5500,2026:5600};function Oe(a,e){const r=a-1,n=we[r]||we[2024],i=Pe[r]||Pe[2024];return e<=8?n[e]||n[1]:n[8]+(e-8)*i}function ke(a){const e=Math.round(a);return t(`[FORM 8962] Applicable % lookup: raw FPL%=${a.toFixed(2)}, rounded=${e}`),e<100||e<150?0:e<200?(e-150)/50*.02:e<250?.02+(e-200)/50*.02:e<300?.04+(e-250)/50*.02:e<400?.06+(e-300)/100*.025:.085}const Be=[{maxFplPercent:200,limits:{single:375,other:750}},{maxFplPercent:300,limits:{single:950,other:1900}},{maxFplPercent:400,limits:{single:1575,other:3150}}],Ne=[{maxFplPercent:200,limits:{single:400,other:800}},{maxFplPercent:300,limits:{single:1e3,other:2e3}},{maxFplPercent:400,limits:{single:1650,other:3300}}],ve=[{maxFplPercent:200,limits:{single:425,other:850}},{maxFplPercent:300,limits:{single:1050,other:2100}},{maxFplPercent:400,limits:{single:1725,other:3450}}];function $e(a){return a===2024?Be:a===2025?Ne:ve}function Ue(a,e,r){if(e>=400)return null;const n=$e(a),i=r==="single"||r==="married_filing_separately";for(const s of n)if(e<s.maxFplPercent)return i?s.limits.single:s.limits.other;return null}function je(a){const{taxYear:e,householdIncome:r,familySize:n,filingStatus:i,form1095AData:s}=a,o=Oe(e,n),d=r/o*100,h=ke(d),T=r*h,I=T/12;let m=0,D=0,_=0,S=0;for(const p of s)m+=p.annualPremium,D+=p.annualSlcsp,_+=p.annualAptc,S=Math.max(S,p.coverageMonths||12);let C=0;const q=Math.round(I);if(s.length>0&&s[0].monthlyPremiums?.length===12)for(let p=0;p<12;p++){let R=0,b=0;for(const y of s)R+=y.monthlyPremiums?.[p]||0,b+=y.monthlySlcsp?.[p]||0;if(R>0&&b>0){const y=Math.max(0,b-q),F=Math.min(R,y);C+=F}}else{const p=S||12,R=m/p,b=D/p;for(let y=0;y<p;y++){const F=Math.max(0,b-q),B=Math.min(R,F);C+=B}}C=Math.round(C);const w=C-_;let P=0,X=0,M=0,E=null;return w>=0?X=w:(P=Math.abs(w),E=Ue(e,d,i),E!==null?M=Math.min(P,E):M=P),{householdIncome:r,familySize:n,federalPovertyLevel:o,incomeAsFplPercent:Math.round(d*10)/10,applicablePercentage:Math.round(h*1e4)/100,annualContributionAmount:Math.round(T),monthlyContribution:Math.round(I*100)/100,totalAnnualPremium:m,totalAnnualSlcsp:D,totalAnnualAptc:_,coverageMonths:S||12,annualPtcAllowed:C,netPtc:w,excessAptc:P,repaymentLimitation:E,excessAptcRepayment:M,additionalPtc:X,line11_annualContribution:Math.round(T),line24_totalPtcAllowed:C,line25_totalAptc:_,line26_netPtc:X,line27_excessAptc:P,line28_repaymentLimitation:E,line29_excessAptcRepayment:M}}function Je(a){const e=(a.drakeFormType||"").toLowerCase(),r=(a.documentType||"").toLowerCase();if(e==="1095_a"||e==="1095-a"||e==="form_1095_a"||e==="form_1095-a"||r==="1095_a"||r==="1095-a"||r==="form_1095_a"||r==="form_1095-a"||r==="1095a"||r.includes("1095-a")||r.includes("1095_a")||r.includes("1095"))return!0;const n=a.extractedAmounts;return!!(n&&(n.annualPremiumAmount||n.annualSlcspPremium||n.annualAdvancePtc))}function De(a,e,r,n,i){const s=i.filter(d=>Je(d)&&d.extractedAmounts);if(t("[FORM 8962] Checking documents for 1095-A..."),t("[FORM 8962] Total documents:",i.length),t("[FORM 8962] Found 1095-A documents:",s.length),s.length>0&&s.forEach((d,h)=>{t(`[FORM 8962] 1095-A #${h+1}:`,{drakeFormType:d.drakeFormType,documentType:d.documentType,extractedAmounts:d.extractedAmounts})}),s.length===0)return t("[FORM 8962] No 1095-A documents found with extracted amounts"),null;const o=s.map(d=>({annualPremium:d.extractedAmounts?.annualPremiumAmount||0,annualSlcsp:d.extractedAmounts?.annualSlcspPremium||0,annualAptc:d.extractedAmounts?.annualAdvancePtc||0,monthlyPremiums:d.extractedAmounts?.monthlyPremiums,monthlySlcsp:d.extractedAmounts?.monthlySlcsp,monthlyAptc:d.extractedAmounts?.monthlyAptc,coverageMonths:d.extractedAmounts?.coverageMonths}));return t("[FORM 8962] Extracted 1095-A data:",o),je({taxYear:a,householdIncome:e,familySize:r,filingStatus:n,form1095AData:o})}const et=async a=>{try{const e=u.state.profile;e?.uid;const r=Date.now(),n={...a,id:Ce(),businessId:u.getBusinessId(),createdAt:r,updatedAt:r,createdBy:e.uid,documentCount:0,verifiedDocumentCount:0},i={query:"addTaxPortal",params:{businessId:u.getBusinessId()},form:n};return t("Creating tax portal:",i),(await A(i))?.taxPortal||n}catch(e){throw t("Error creating tax portal:",e),new Error("Error al crear el portal de impuestos")}},tt=async a=>{try{if(!u.state.user)throw new Error("Usuario no autenticado");let r={businessId:u.getBusinessId()};a&&a.trim();let o=((await A({query:"getTaxPortal",params:r}))?.data||[]).filter(d=>d.type==="document"||d.type==="checklist"?!1:d.firstName||d.lastName);if(!u.isAdmin()){const d=u.getAllowedStoreIds();o=o.filter(h=>h.storeId?d.includes(h.storeId):!0)}return o}catch(e){return t("Error getting tax portals:",e),[]}},at=async a=>{try{const e={query:"getTaxPortal",params:{businessId:u.getBusinessId(),id:a}},r=await A(e);return(r?.data?.taxPortal||r?.data||r?.taxPortal).filter(s=>s.id===a)?.[0]||null}catch(e){return t("Error getting tax portal:",e),null}},rt=async(a,e)=>{try{const r={query:"updateTaxPortal",params:{businessId:u.getBusinessId(),id:a},form:{...e,updatedAt:Date.now()}};return(await A(r))?.taxPortal||{id:a,...e}}catch(r){throw t("Error updating tax portal:",r),new Error("Error al actualizar el portal de impuestos")}},nt=async a=>{try{const e={query:"deleteTaxPortal",params:{businessId:u.getBusinessId(),id:a}};await A(e)}catch(e){throw t("Error deleting tax portal:",e),new Error("Error al eliminar el portal de impuestos")}},We=()=>{const a=Date.now().toString(36),e=Math.random().toString(36).substring(2,12);return`TDR-${a}-${e}`.toUpperCase()},ze=()=>Math.floor(1e5+Math.random()*9e5).toString(),Ye=(a,e)=>{const r=`${window.location.origin}/#/tax-upload/${a}/${e}`;return`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(r)}`},st=async(a,e)=>{try{const r=u.state.profile;r?.uid;const n=Date.now(),i=e.expirationDays||30,s=We(),o=Ce(),d={id:o,title:e?.task?.title,taxPortalId:a?.id,recipientName:`${a?.firstName} ${a?.lastName}`.trim(),clientName:`${a?.firstName} ${a?.lastName}`.trim(),clientEmail:a?.email,recipientEmail:a?.email,clientPhone:a?.phone,accessToken:s,accessPin:ze(),qrCodeUrl:Ye(o,s),taxYear:e.taxYear,requestedDocuments:e.requestedDocuments||[...Fe],instructions:e.instructions,status:"pending",uploadedDocuments:[],createdAt:n,expiresAt:n+i*24*60*60*1e3,requestedBy:r.uid,requestedByName:r.displayName||r.email||"Unknown",businessId:u.getBusinessId()||"",storeId:a?.storeId,storeName:a?.storeName},h={query:"addTaxDocumentRequest",params:{businessId:u.getBusinessId()},form:d};return(await A(h))?.documentRequest||d}catch(r){throw t("Error creating document request:",r),new Error("Error al crear la solicitud de documentos")}},Qe=async(a,e,r)=>{try{const s=(await U({query:"getTaxDocumentRequestByToken",params:{accessToken:e,id:a,verifySignature:r}}))?.data;if(!s)return null;s.expiresAt<Date.now()&&s.status==="pending"&&(s.status="expired");try{await ye(s.id,s.businessId)}catch{}return s}catch(n){return t("Error getting document request by token:",n),null}},it=async(a,e)=>{try{const r=await Qe(a,e);if(!r||!r.taxPortalId)return null;const n={query:"getTaxPortalPublic",params:{id:r.taxPortalId,requestId:a,accessToken:e}},i=await U(n);return i?.data?.[0]||i?.data||null}catch(r){return t("Error getting tax portal by request:",r),null}},ot=async(a,e,r)=>{try{const s=(await U({query:"getSignatureValidationByToken",params:{accessToken:e,id:a,verifySignature:r}}))?.data;if(!s)return null;s.expiresAt<Date.now()&&s.status==="pending"&&(s.status="expired");try{await ye(s.id,s.businessId)}catch{}return s}catch(n){return t("Error getting document request by token:",n),null}},lt=async a=>{try{const n=(await A({query:"getTaxDocumentRequestByPin",params:{accessPin:a}}))?.documentRequest;if(!n)return null;n.expiresAt<Date.now()&&n.status==="pending"&&(n.status="expired");try{await ye(n.id,n.businessId)}catch{}return n}catch(e){return t("Error getting document request by PIN:",e),null}},ye=async(a,e)=>{const r={query:"updateTaxDocumentRequestLastAccess",params:{businessId:e,id:a},form:{lastAccessedAt:Date.now()}};await U(r)},dt=async a=>{try{const e={query:"getTaxDocumentRequestsByRecipient",params:{businessId:u.getBusinessId(),recipientId:a}},r=await A(e);return r?.data?.data||r?.data||[]}catch(e){return t("Error getting document requests:",e),[]}},ct=async a=>{try{if(!u.state.user)throw new Error("Usuario no autenticado");const r={query:"getTaxDocumentRequests",params:{businessId:u.getBusinessId()}},n=await A(r);let i=n?.data?.data||n?.data||[];if(!u.isAdmin()){const s=u.getAllowedStoreIds();i=i.filter(o=>o.storeId?s.includes(o.storeId):!0)}return a?.status,a?.taxYear,i.sort((s,o)=>o.createdAt-s.createdAt),i}catch(e){return t("Error getting document requests:",e),[]}},ut=async(a,e,r,n)=>{try{const o=(await A({query:"getTaxDocumentRequestById",params:{businessId:e,id:a}}))?.documentRequest;if(!o)throw new Error("Request not found");const d=o.requestedDocuments.map(m=>m.type===r?{...m,uploaded:!0,documentId:n}:m),h=d.filter(m=>m.required).every(m=>m.uploaded),T=d.some(m=>m.uploaded),I={query:"updateTaxDocumentRequest",params:{businessId:e,id:a},form:{requestedDocuments:d,uploadedDocuments:[...o.uploadedDocuments||[],n],status:h?"complete":T?"partial":"pending"}};await A(I)}catch(i){throw t("Error marking document uploaded:",i),i}},mt=async a=>{try{const e={query:"updateTaxDocumentRequest",params:{businessId:u.getBusinessId(),id:a},form:{status:"cancelled"}};await A(e)}catch(e){throw t("Error cancelling document request:",e),new Error("Error al cancelar la solicitud")}},ht=async a=>{try{const e={query:"deleteTaxDocumentRequest",params:{businessId:u.getBusinessId(),id:a}};await A(e)}catch(e){throw t("Error deleting document request:",e),new Error("Error al eliminar la solicitud")}},pt=async a=>{try{const e={query:"sendTaxDocumentRequestReminder",params:{businessId:u.getBusinessId(),id:a}},r=await A(e);r?.success&&await A({query:"updateTaxDocumentRequest",params:{businessId:u.getBusinessId(),id:a},form:{remindersSent:(r.remindersSent||0)+1}})}catch(e){throw t("Error sending reminder:",e),new Error("Error al enviar el recordatorio")}},At=async(a,e,r,n)=>{try{const i={query:"markDocumentNotNeeded",params:{businessId:u.getBusinessId(),id:a,documentType:e,notNeeded:r,reason:n,markedBy:"accountant",markedAt:Date.now()}},s=await A(i);return{success:!0}}catch(i){return t("Error marking document as not needed:",i),{success:!1,error:"Error updating document status"}}},gt=a=>`${window.location.origin}/#/tax-upload/${a}`,ft=()=>`${window.location.origin}/#/tax-upload-pin`,Ct=a=>{const e=Date.now(),r=a-e;if(r<=0)return"Expirado";const n=Math.floor(r/(24*60*60*1e3)),i=Math.floor(r%(24*60*60*1e3)/(60*60*1e3));return n>0?`${n} día${n>1?"s":""} restante${n>1?"s":""}`:`${i} hora${i>1?"s":""} restante${i>1?"s":""}`},yt=a=>a.expiresAt<Date.now(),Tt=a=>{const e=a.requestedDocuments.length,r=a.requestedDocuments.filter(n=>n.uploaded).length;return Math.round(r/e*100)},bt=a=>a.requestedDocuments.filter(e=>e.required&&!e.uploaded),Lt=async(a,e,r,n)=>{try{const i=await U({query:"updateTaxDocumentRequest",params:{requestId:a,id:a,accessToken:e,businessId:n},form:r});return{success:!0}}catch(i){return t("Error updating document request:",i),{success:!1,error:i.message}}};async function xt(a,e,r,n){try{const i=await a.arrayBuffer(),s=Array.from(new Uint8Array(i)),o=await U({query:"uploadTaxDocument",params:{businessId:n?.businessId||u.getBusinessId()},form:{fileBuffer:s,fileName:a.name,mimeType:a.type,fileSize:a.size,taxPortalId:e,taxYear:r,businessId:n?.businessId||u.getBusinessId(),documentType:n?.documentType,tags:n?.tags,notes:n?.notes}});return o?.success&&o?.documentId?{success:!0,documentId:o.documentId,document:o.document}:{success:!1,error:o?.error||"Failed to upload document"}}catch(i){return t("Error uploading tax document:",i),{success:!1,error:i.message}}}const Ge=a=>{const e={2024:{taxYear:2024,standardDeductions:{single:14600,married_jointly:29200,married_separately:14600,head_of_household:21900,qualifying_widow:29200},taxBrackets:{single:[{limit:11600,rate:.1,base:0,threshold:0},{limit:47150,rate:.12,base:1160,threshold:11600},{limit:100525,rate:.22,base:5426,threshold:47150},{limit:191950,rate:.24,base:17168.5,threshold:100525},{limit:243725,rate:.32,base:39110.5,threshold:191950},{limit:609350,rate:.35,base:55678.5,threshold:243725},{limit:1/0,rate:.37,base:183647.25,threshold:609350}],married_jointly:[{limit:23200,rate:.1,base:0,threshold:0},{limit:94300,rate:.12,base:2320,threshold:23200},{limit:201050,rate:.22,base:10852,threshold:94300},{limit:383900,rate:.24,base:34337,threshold:201050},{limit:487450,rate:.32,base:78221,threshold:383900},{limit:731200,rate:.35,base:111357,threshold:487450},{limit:1/0,rate:.37,base:196669.5,threshold:731200}],married_separately:[{limit:11600,rate:.1,base:0,threshold:0},{limit:47150,rate:.12,base:1160,threshold:11600},{limit:100525,rate:.22,base:5426,threshold:47150},{limit:191950,rate:.24,base:17168.5,threshold:100525},{limit:243725,rate:.32,base:39110.5,threshold:191950},{limit:365600,rate:.35,base:55678.5,threshold:243725},{limit:1/0,rate:.37,base:98334.75,threshold:365600}],head_of_household:[{limit:16550,rate:.1,base:0,threshold:0},{limit:63100,rate:.12,base:1655,threshold:16550},{limit:100500,rate:.22,base:7241,threshold:63100},{limit:191950,rate:.24,base:15469,threshold:100500},{limit:243700,rate:.32,base:37417,threshold:191950},{limit:609350,rate:.35,base:53977,threshold:243700},{limit:1/0,rate:.37,base:181954.5,threshold:609350}]},saltCap:1e4,saltCapMFS:5e3,additionalDeduction65Plus:{single:1950,married:1550},eitcBrackets:{0:{maxCredit:632,phaseInEnd:7840,phaseOutStartSingle:9800,phaseOutStartMFJ:16370,singleLimit:18591,mfjLimit:25511,phaseInRate:.0765,phaseOutRate:.0765},1:{maxCredit:4213,phaseInEnd:12390,phaseOutStartSingle:22720,phaseOutStartMFJ:29290,singleLimit:49084,mfjLimit:56004,phaseInRate:.34,phaseOutRate:.1598},2:{maxCredit:6960,phaseInEnd:17400,phaseOutStartSingle:22720,phaseOutStartMFJ:29290,singleLimit:55768,mfjLimit:62688,phaseInRate:.4,phaseOutRate:.2106},3:{maxCredit:7830,phaseInEnd:17400,phaseOutStartSingle:22720,phaseOutStartMFJ:29290,singleLimit:59899,mfjLimit:66819,phaseInRate:.45,phaseOutRate:.2106}},childTaxCredit:{amountPerChild:2e3,maxRefundablePerChild:1700,phaseOutThresholdSingle:2e5,phaseOutThresholdMFJ:4e5}},2025:{taxYear:2025,standardDeductions:{single:15750,married_jointly:31500,married_separately:15750,head_of_household:23625,qualifying_widow:31500},taxBrackets:{single:[{limit:11925,rate:.1,base:0,threshold:0},{limit:48475,rate:.12,base:1192.5,threshold:11925},{limit:103350,rate:.22,base:5578.5,threshold:48475},{limit:197300,rate:.24,base:17651,threshold:103350},{limit:250525,rate:.32,base:40199,threshold:197300},{limit:626350,rate:.35,base:57231,threshold:250525},{limit:1/0,rate:.37,base:188769.75,threshold:626350}],married_jointly:[{limit:23850,rate:.1,base:0,threshold:0},{limit:96950,rate:.12,base:2385,threshold:23850},{limit:206700,rate:.22,base:11157,threshold:96950},{limit:394600,rate:.24,base:35302,threshold:206700},{limit:501050,rate:.32,base:80398,threshold:394600},{limit:751600,rate:.35,base:114462,threshold:501050},{limit:1/0,rate:.37,base:202154.5,threshold:751600}],married_separately:[{limit:11925,rate:.1,base:0,threshold:0},{limit:48475,rate:.12,base:1192.5,threshold:11925},{limit:103350,rate:.22,base:5578.5,threshold:48475},{limit:197300,rate:.24,base:17651,threshold:103350},{limit:250525,rate:.32,base:40199,threshold:197300},{limit:375800,rate:.35,base:57231,threshold:250525},{limit:1/0,rate:.37,base:101077.25,threshold:375800}],head_of_household:[{limit:17e3,rate:.1,base:0,threshold:0},{limit:64850,rate:.12,base:1700,threshold:17e3},{limit:103350,rate:.22,base:7442,threshold:64850},{limit:197300,rate:.24,base:15912,threshold:103350},{limit:250500,rate:.32,base:38460,threshold:197300},{limit:626350,rate:.35,base:55484,threshold:250500},{limit:1/0,rate:.37,base:187032,threshold:626350}]},saltCap:1e4,saltCapMFS:5e3,additionalDeduction65Plus:{single:2e3,married:1600},eitcBrackets:{0:{maxCredit:649,phaseInEnd:8490,phaseOutStartSingle:10620,phaseOutStartMFJ:17620,singleLimit:19104,mfjLimit:26214,phaseInRate:.0765,phaseOutRate:.0765},1:{maxCredit:4328,phaseInEnd:12730,phaseOutStartSingle:23350,phaseOutStartMFJ:30350,singleLimit:50434,mfjLimit:57554,phaseInRate:.34,phaseOutRate:.1598},2:{maxCredit:7152,phaseInEnd:17880,phaseOutStartSingle:23350,phaseOutStartMFJ:30350,singleLimit:57310,mfjLimit:64430,phaseInRate:.4,phaseOutRate:.2106},3:{maxCredit:8046,phaseInEnd:17880,phaseOutStartSingle:23350,phaseOutStartMFJ:30350,singleLimit:61555,mfjLimit:68675,phaseInRate:.45,phaseOutRate:.2106}},childTaxCredit:{amountPerChild:2200,maxRefundablePerChild:1700,phaseOutThresholdSingle:2e5,phaseOutThresholdMFJ:4e5}}};return e[a]||e[2025]},He={single:"Single",married_filing_jointly:"Married Filing Jointly",married_jointly:"Married Filing Jointly",married_filing_separately:"Married Filing Separately",married_separate:"Married Filing Separately",head_of_household:"Head of Household",head_household:"Head of Household",qualifying_widow:"Qualifying Surviving Spouse"},Ke=a=>({married_jointly:"married_jointly",married_filing_jointly:"married_jointly",married_separate:"married_separately",married_filing_separately:"married_separately",head_household:"head_of_household",head_of_household:"head_of_household",single:"single",qualifying_widow:"qualifying_widow"})[a]||"single",It=async(a,e,r,n,i)=>{t("[TAX CALC] ===== TAX CALCULATION STARTED ====="),t("[TAX CALC] Client:",JSON.stringify({id:a,name:`${n.firstName} ${n.lastName}`,filingStatus:n.filingStatus,taxYear:e,dependentsCount:n.dependents?.length||0})),t("[TAX CALC] Documents count:",r.length);const s=Ge(e),o=Ke(n.filingStatus||"single"),d=o==="married_separately";t("[TAX CALC] Filing status:",o),t("[TAX CALC] Tax year constants:",JSON.stringify({standardDeductions:s.standardDeductions,saltCap:s.saltCap,saltCapMFS:s.saltCapMFS}));let h=0,T=0,I=0,m=0,D=0,_=0,S=0,C=0,q=0,w=0,P=0,X=0,M=0,E=0,p=0,R=0;t("[TAX CALC] --- Processing Documents ---"),r.forEach((l,g)=>{if(t(`[TAX CALC] Doc ${g+1}: type=${l.drakeFormType||l.documentType} | verified=${l.verified} | hasAmounts=${!!l.extractedAmounts} | file=${l.originalFileName}`),l.verified&&l.extractedAmounts){const c=l.extractedAmounts;t(`[TAX CALC] Doc ${g+1} extractedAmounts:`,JSON.stringify(c)),c.wages&&(h+=c.wages),c.interestIncome&&(I+=c.interestIncome),c.ordinaryDividends&&(m+=c.ordinaryDividends),c.nonEmployeeCompensation&&(D+=c.nonEmployeeCompensation),c.rents&&(_+=c.rents),c.royalties&&(S+=c.royalties),c.otherIncome&&(C+=c.otherIncome),c.federalTaxWithheld&&(q+=c.federalTaxWithheld),c.federalTaxWithheld1099&&(w+=c.federalTaxWithheld1099),c.stateTaxWithheld&&(P+=c.stateTaxWithheld),c.localTaxWithheld&&(X+=c.localTaxWithheld),c.propertyTaxes&&(M+=c.propertyTaxes),c.mortgageInterest&&(E+=c.mortgageInterest),c.pointsPaid&&(p+=c.pointsPaid),c.mortgageInsurancePremiums&&(R+=c.mortgageInsurancePremiums)}});const b=h+T,y=D+_+S+C,F=b+I+m+y,B=q+w;t("[TAX CALC] --- Income Summary ---"),t("[TAX CALC] Line 1a (Wages):",h),t("[TAX CALC] Line 1h (Other earned):",T),t("[TAX CALC] Line 1z (Total wages):",b),t("[TAX CALC] Line 2b (Taxable interest):",I),t("[TAX CALC] Line 3b (Ordinary dividends):",m),t("[TAX CALC] Line 8 breakdown:",JSON.stringify({business:D,rental:_,royalties:S,other:C})),t("[TAX CALC] Line 8 (Other income total):",y),t("[TAX CALC] Line 9 (TOTAL INCOME):",F),t("[TAX CALC] Line 25a (W-2 withholding):",q),t("[TAX CALC] Line 25b (1099 withholding):",w),t("[TAX CALC] Line 25d (Total withholding):",B);const G=s.standardDeductions[o]||s.standardDeductions.single,Te=d?s.saltCapMFS:s.saltCap,be=P+X+M,ee=Math.min(be,Te),te=E+p+R,Le=0,H=ee+te+Le,ae=H>G,re=ae?H:G,ne=i?.qbid||0,se=i?.schedule1ADeductions||0,ie=re+ne+se,oe=0,L=F-oe,K=Math.max(0,L-ie);t("[TAX CALC] --- Deductions ---"),t("[TAX CALC] SALT breakdown:",JSON.stringify({state:P,local:X,property:M,total:be})),t("[TAX CALC] SALT cap:",Te),t("[TAX CALC] SALT deduction (capped):",ee),t("[TAX CALC] Mortgage interest:",te),t("[TAX CALC] Itemized total:",H),t("[TAX CALC] Standard deduction:",G),t("[TAX CALC] Line 12e (Std/Itemized):",ae?"ITEMIZED":"STANDARD","=",re),t("[TAX CALC] Line 13a (QBID):",ne),t("[TAX CALC] Line 13b (Schedule 1-A):",se),t("[TAX CALC] Line 14 (Total deductions):",ie),t("[TAX CALC] Line 10 (Adjustments):",oe),t("[TAX CALC] Line 11 (AGI):",L),t("[TAX CALC] Line 15 (TAXABLE INCOME):",K);let j;o==="married_jointly"||o==="qualifying_widow"?j=s.taxBrackets.married_jointly:o==="head_of_household"?j=s.taxBrackets.head_of_household:o==="married_separately"?j=s.taxBrackets.married_separately:j=s.taxBrackets.single;let N=0,le="",de=0;for(const l of j)if(K<=l.limit){N=l.base+(K-l.threshold)*l.rate,de=l.rate,le=`${(l.rate*100).toFixed(0)}% bracket ($${l.threshold.toLocaleString()} - $${l.limit===1/0?"∞":l.limit.toLocaleString()})`;break}const ce=1+(o==="married_jointly"?1:0)+(n.dependents?.length||0);let f=De(e,L,ce,o,r);if(!f&&n.taxStrategy?.otherIncome?.healthInsuranceMarketplace){const l=n.taxStrategy.otherIncome.healthInsuranceMarketplace;if(l.hasMarketplaceCoverage&&l.coverageMonths>0){t("[TAX CALC] No 1095-A document found, using Strategy health insurance marketplace data"),t("[TAX CALC] Marketplace data:",JSON.stringify(l));const g={drakeFormType:"1095_a",documentType:"1095_a",extractedAmounts:{annualPremiumAmount:l.monthlyPremium*l.coverageMonths,annualSlcspPremium:l.monthlySlcsp*l.coverageMonths,annualAdvancePtc:l.monthlyAptc*l.coverageMonths,coverageMonths:l.coverageMonths}};f=De(e,L,ce,o,[g])}}f&&(t("[TAX CALC] --- Form 8962 Premium Tax Credit ---"),t("[TAX CALC] Family size:",ce),t("[TAX CALC] Income as % FPL:",f.incomeAsFplPercent+"%"),t("[TAX CALC] Applicable %:",f.applicablePercentage+"%"),t("[TAX CALC] Annual PTC allowed:",f.annualPtcAllowed),t("[TAX CALC] Total APTC received:",f.totalAnnualAptc),t("[TAX CALC] Excess APTC:",f.excessAptc),t("[TAX CALC] Repayment limitation:",f.repaymentLimitation),t("[TAX CALC] Line 29 (Excess repayment):",f.excessAptcRepayment),t("[TAX CALC] Additional PTC credit:",f.additionalPtc));const Me=i?.schedule2Tax||0,Ee=f?.excessAptcRepayment||0,ue=Me+Ee,me=N+ue;t("[TAX CALC] --- Tax Calculation ---"),t("[TAX CALC] Brackets used for:",o),t("[TAX CALC] Bracket:",le),t("[TAX CALC] Line 16 (Tax from brackets):",N),t("[TAX CALC] Line 17 (Schedule 2 taxes):",ue),t("[TAX CALC] Line 18 (Total tax before credits):",me),t("[TAX CALC] Marginal rate:",(de*100).toFixed(0)+"%");const Re=["son","daughter","stepson","stepdaughter","foster_child","grandchild"],he=new Date(e,11,31),V=(n.dependents||[]).filter(l=>{if(!Re.includes(l.relationship))return!1;if(l.dateOfBirth){const g=new Date(l.dateOfBirth);return he.getFullYear()-g.getFullYear()-(he<new Date(he.getFullYear(),g.getMonth(),g.getDate())?1:0)<17}return!0});t("[TAX CALC] --- Credits Calculation ---"),t("[TAX CALC] Total dependents:",n.dependents?.length||0),t("[TAX CALC] Qualifying children (under 17):",V.length),t("[TAX CALC] Dependents detail:",JSON.stringify(n.dependents?.map(l=>({name:`${l.firstName} ${l.lastName}`,relationship:l.relationship,dob:l.dateOfBirth}))));const J=s.childTaxCredit,qe=J.amountPerChild,pe=o==="married_jointly"?J.phaseOutThresholdMFJ:J.phaseOutThresholdSingle;let W=V.length*qe;if(L>pe){const l=L-pe,g=Math.ceil(l/1e3)*50;W=Math.max(0,W-g),t("[TAX CALC] CTC phase-out: AGI",L,"> threshold",pe,", reduction:",g)}const z=Math.min(W,me),Z=Math.min(V.length*J.maxRefundablePerChild,W-z);t("[TAX CALC] Child Tax Credit constants:",JSON.stringify(J)),t("[TAX CALC] Child Tax Credit (before limit):",W),t("[TAX CALC] Non-refundable CTC (limited to Line 18 tax):",z),t("[TAX CALC] Additional Child Tax Credit (refundable):",Z);const Y=b,xe=o==="married_jointly",Ie=Math.min(V.length,3),x=s.eitcBrackets[Ie],_e=xe?x.mfjLimit:x.singleLimit,Q=xe?x.phaseOutStartMFJ:x.phaseOutStartSingle,v=Math.max(Y,L);let O=0,$="";if(Y<=0)O=0,$="no-income";else if(v>_e)O=0,$="over-limit";else{const l=Math.min(Y*x.phaseInRate,x.maxCredit);let g=0;v>Q&&(g=(v-Q)*x.phaseOutRate),O=Math.max(0,Math.floor(l-g)),Y<=x.phaseInEnd&&v<=Q?$="phase-in":v<=Q?$="plateau":$="phase-out",t("[TAX CALC] EIC Phase-in credit:",l.toFixed(2),"| Phase-out reduction:",g.toFixed(2))}t("[TAX CALC] EITC constants for",e,":",JSON.stringify(x)),t("[TAX CALC] Earned income for EIC:",Y,"| AGI:",L,"| Income for phase-out:",v),t("[TAX CALC] EIC bracket:",Ie,"children | Phase-in end:",x.phaseInEnd,"| Phase-out start:",Q,"| Max income:",_e),t("[TAX CALC] EIC phase:",$,"| Final credit:",O);const Ae=z,ge=Math.max(0,N-Ae),Xe=Z+O,fe=B+Xe,k=fe-ge;t("[TAX CALC] --- Final Calculation ---"),t("[TAX CALC] Line 16 (Tax before credits):",N),t("[TAX CALC] Line 19 (Child Tax Credit):",z),t("[TAX CALC] Line 21 (Total non-refundable credits):",Ae),t("[TAX CALC] Line 24 (Total tax after credits):",ge),t("[TAX CALC] Line 25d (Withholding):",B),t("[TAX CALC] Line 27 (EIC - refundable):",O),t("[TAX CALC] Line 28 (ACTC - refundable):",Z),t("[TAX CALC] Line 33 (Total payments + refundable credits):",fe),t("[TAX CALC] RESULT:",k>0?`REFUND $${k.toFixed(2)}`:`OWED $${Math.abs(k).toFixed(2)}`);const Se={id:Ce(),taxPortalId:a,taxYear:e,filingStatus:o,filingStatusLabel:He[n.filingStatus||"single"]||"Single",calculatedAt:Date.now(),line1a_wages:h,line1h_otherEarnedIncome:T,line1z_totalWages:b,line2b_taxableInterest:I,line3b_ordinaryDividends:m,line8_otherIncome:y,line8_breakdown:{businessIncome:D,rentalIncome:_,royalties:S,other:C},line9_totalIncome:F,line10_adjustments:oe,line11_agi:L,line12a_standardDeduction:G,line12b_itemizedDeductions:H,line12b_breakdown:{saltDeduction:ee,mortgageInterest:te,charitableContributions:Le},line12_deductionUsed:ae?"itemized":"standard",line12_deductionAmount:re,line13a_qbid:ne,line13b_schedule1ADeductions:se,line14_totalDeductions:ie,line15_taxableIncome:K,line16_tax:N,line16_bracketUsed:le,line16_marginalRate:de,line17_schedule2Tax:ue,line18_totalTaxBeforeCredits:me,line19_childTaxCredit:z,line21_totalCredits:Ae,line24_totalTax:ge,line25a_w2Withholding:q,line25b_1099Withholding:w,line25d_totalWithholding:B,line27_eic:O,line28_actc:Z,line33_totalPayments:fe,line34_refund:k>0?k:0,line37_amountOwed:k<0?Math.abs(k):0,form8962:f||void 0};return t("[TAX CALC] ===== FULL RESULT ====="),t("[TAX CALC]",JSON.stringify(Se,null,2)),t("[TAX CALC] ===== TAX CALCULATION COMPLETE ====="),Se};export{Tt as a,gt as b,ft as c,st as d,mt as e,Ct as f,dt as g,ht as h,yt as i,tt as j,ct as k,et as l,nt as m,At as n,It as o,at as p,Qe as q,bt as r,pt as s,Lt as t,rt as u,xt as v,ut as w,lt as x,it as y,ot as z};
