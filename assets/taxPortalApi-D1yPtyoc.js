import{aE as m,g as a,O as c,P as g}from"./index-CPuBG4SZ.js";import{a as w}from"./drakeTypes-DcjcYEfx.js";const x=async r=>{try{const e=a.state.profile;e?.uid;const t=Date.now(),s={...r,id:g(),businessId:a.getBusinessId(),createdAt:t,updatedAt:t,createdBy:e.uid,documentCount:0,verifiedDocumentCount:0},o={query:"addTaxPortal",params:{businessId:a.getBusinessId()},form:s};return(await c(o))?.taxPortal||s}catch(e){throw console.error("Error creating tax portal:",e),new Error("Error al crear el portal de impuestos")}},E=async r=>{try{if(!a.state.user)throw new Error("Usuario no autenticado");let t={businessId:a.getBusinessId()};r&&r.trim();let u=((await c({query:"getTaxPortal",params:t}))?.data||[]).filter(d=>d.type==="document"||d.type==="checklist"?!1:d.firstName||d.lastName);if(!a.isAdmin()){const d=a.getAllowedStoreIds();u=u.filter(l=>l.storeId?d.includes(l.storeId):!0)}return u}catch(e){return console.error("Error getting tax portals:",e),[]}},R=async r=>{try{const e={query:"getTaxPortal",params:{businessId:a.getBusinessId(),id:r}},t=await c(e);return(t?.data?.taxPortal||t?.data||t?.taxPortal).filter(n=>n.id===r)?.[0]||null}catch(e){return console.error("Error getting tax portal:",e),null}},T=async(r,e)=>{try{const t={query:"updateTaxPortal",params:{businessId:a.getBusinessId(),id:r},form:{...e,updatedAt:Date.now()}};return(await c(t))?.taxPortal||{id:r,...e}}catch(t){throw console.error("Error updating tax portal:",t),new Error("Error al actualizar el portal de impuestos")}},B=async r=>{try{const e={query:"deleteTaxPortal",params:{businessId:a.getBusinessId(),id:r}};await c(e)}catch(e){throw console.error("Error deleting tax portal:",e),new Error("Error al eliminar el portal de impuestos")}},f=()=>{const r=Date.now().toString(36),e=Math.random().toString(36).substring(2,12);return`TDR-${r}-${e}`.toUpperCase()},D=()=>Math.floor(1e5+Math.random()*9e5).toString(),I=(r,e)=>{const t=`${window.location.origin}/#/tax-upload/${r}/${e}`;return`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(t)}`},A=async(r,e)=>{try{const t=a.state.profile;t?.uid;const s=Date.now(),o=e.expirationDays||30,n=f(),u=g(),d={id:u,title:e?.task?.title,taxPortalId:r?.id,recipientName:`${r?.firstName} ${r?.lastName}`.trim(),clientName:`${r?.firstName} ${r?.lastName}`.trim(),clientEmail:r?.email,recipientEmail:r?.email,clientPhone:r?.phone,accessToken:n,accessPin:D(),qrCodeUrl:I(u,n),taxYear:e.taxYear,requestedDocuments:e.requestedDocuments||[...w],instructions:e.instructions,status:"pending",uploadedDocuments:[],createdAt:s,expiresAt:s+o*24*60*60*1e3,requestedBy:t.uid,requestedByName:t.displayName||t.email||"Unknown",businessId:a.getBusinessId()||"",storeId:r?.storeId,storeName:r?.storeName},l={query:"addTaxDocumentRequest",params:{businessId:a.getBusinessId()},form:d};return(await c(l))?.documentRequest||d}catch(t){throw console.error("Error creating document request:",t),new Error("Error al crear la solicitud de documentos")}},U=async(r,e,t)=>{try{const n=(await m({query:"getTaxDocumentRequestByToken",params:{accessToken:e,id:r,verifySignature:t}}))?.data;if(!n)return null;n.expiresAt<Date.now()&&n.status==="pending"&&(n.status="expired");try{await p(n.id,n.businessId)}catch{}return n}catch(s){return console.error("Error getting document request by token:",s),null}},P=async(r,e,t)=>{try{const n=(await m({query:"getSignatureValidationByToken",params:{accessToken:e,id:r,verifySignature:t}}))?.data;if(!n)return null;n.expiresAt<Date.now()&&n.status==="pending"&&(n.status="expired");try{await p(n.id,n.businessId)}catch{}return n}catch(s){return console.error("Error getting document request by token:",s),null}},S=async r=>{try{const s=(await c({query:"getTaxDocumentRequestByPin",params:{accessPin:r}}))?.documentRequest;if(!s)return null;s.expiresAt<Date.now()&&s.status==="pending"&&(s.status="expired");try{await p(s.id,s.businessId)}catch{}return s}catch(e){return console.error("Error getting document request by PIN:",e),null}},p=async(r,e)=>{const t={query:"updateTaxDocumentRequestLastAccess",params:{businessId:e,id:r},form:{lastAccessedAt:Date.now()}};await m(t)},k=async r=>{try{const e={query:"getTaxDocumentRequestsByRecipient",params:{businessId:a.getBusinessId(),recipientId:r}},t=await c(e);return t?.data?.data||t?.data||[]}catch(e){return console.error("Error getting document requests:",e),[]}},N=async r=>{try{if(!a.state.user)throw new Error("Usuario no autenticado");const t={query:"getTaxDocumentRequests",params:{businessId:a.getBusinessId()}},s=await c(t);let o=s?.data?.data||s?.data||[];if(!a.isAdmin()){const n=a.getAllowedStoreIds();o=o.filter(u=>u.storeId?n.includes(u.storeId):!0)}return r?.status,r?.taxYear,o.sort((n,u)=>u.createdAt-n.createdAt),o}catch(e){return console.error("Error getting document requests:",e),[]}},$=async(r,e,t,s)=>{try{const u=(await c({query:"getTaxDocumentRequestById",params:{businessId:e,id:r}}))?.documentRequest;if(!u)throw new Error("Request not found");const d=u.requestedDocuments.map(i=>i.type===t?{...i,uploaded:!0,documentId:s}:i),l=d.filter(i=>i.required).every(i=>i.uploaded),y=d.some(i=>i.uploaded),q={query:"updateTaxDocumentRequest",params:{businessId:e,id:r},form:{requestedDocuments:d,uploadedDocuments:[...u.uploadedDocuments||[],s],status:l?"complete":y?"partial":"pending"}};await c(q)}catch(o){throw console.error("Error marking document uploaded:",o),o}},v=async r=>{try{const e={query:"updateTaxDocumentRequest",params:{businessId:a.getBusinessId(),id:r},form:{status:"cancelled"}};await c(e)}catch(e){throw console.error("Error cancelling document request:",e),new Error("Error al cancelar la solicitud")}},M=async r=>{try{const e={query:"deleteTaxDocumentRequest",params:{businessId:a.getBusinessId(),id:r}};await c(e)}catch(e){throw console.error("Error deleting document request:",e),new Error("Error al eliminar la solicitud")}},C=async r=>{try{const e={query:"sendTaxDocumentRequestReminder",params:{businessId:a.getBusinessId(),id:r}},t=await c(e);t?.success&&await c({query:"updateTaxDocumentRequest",params:{businessId:a.getBusinessId(),id:r},form:{remindersSent:(t.remindersSent||0)+1}})}catch(e){throw console.error("Error sending reminder:",e),new Error("Error al enviar el recordatorio")}},L=async(r,e,t,s)=>{try{const o={query:"markDocumentNotNeeded",params:{businessId:a.getBusinessId(),id:r,documentType:e,notNeeded:t,reason:s,markedBy:"accountant",markedAt:Date.now()}},n=await c(o);return{success:!0}}catch(o){return console.error("Error marking document as not needed:",o),{success:!1,error:"Error updating document status"}}},z=r=>`${window.location.origin}/#/tax-upload/${r}`,Q=()=>`${window.location.origin}/#/tax-upload-pin`,Y=r=>{const e=Date.now(),t=r-e;if(t<=0)return"Expirado";const s=Math.floor(t/(24*60*60*1e3)),o=Math.floor(t%(24*60*60*1e3)/(60*60*1e3));return s>0?`${s} dÃ­a${s>1?"s":""} restante${s>1?"s":""}`:`${o} hora${o>1?"s":""} restante${o>1?"s":""}`},_=r=>r.expiresAt<Date.now(),F=r=>{const e=r.requestedDocuments.length,t=r.requestedDocuments.filter(s=>s.uploaded).length;return Math.round(t/e*100)},O=r=>r.requestedDocuments.filter(e=>e.required&&!e.uploaded),j=async(r,e,t,s)=>{try{const o=await m({query:"updateTaxDocumentRequest",params:{requestId:r,id:r,accessToken:e,businessId:s},form:t});return{success:!0}}catch(o){return console.error("Error updating document request:",o),{success:!1,error:o.message}}};async function G(r,e,t,s){try{const o=await r.arrayBuffer(),n=Array.from(new Uint8Array(o)),u=await m({query:"uploadTaxDocument",params:{businessId:s?.businessId||a.getBusinessId()},form:{fileBuffer:n,fileName:r.name,mimeType:r.type,fileSize:r.size,taxPortalId:e,taxYear:t,businessId:s?.businessId||a.getBusinessId(),documentType:s?.documentType,tags:s?.tags,notes:s?.notes}});return u?.success&&u?.documentId?{success:!0,documentId:u.documentId,document:u.document}:{success:!1,error:u?.error||"Failed to upload document"}}catch(o){return console.error("Error uploading tax document:",o),{success:!1,error:o.message}}}export{F as a,z as b,Q as c,A as d,v as e,Y as f,k as g,M as h,_ as i,E as j,N as k,x as l,B as m,L as n,R as o,U as p,O as q,j as r,C as s,G as t,T as u,$ as v,S as w,P as x};
