import{aJ as U,e as u,h as d,P as p,Q as Ce}from"./index-CIjEEChL.js";import{a as Fe}from"./drakeTypes-BxRsJFbg.js";const we={2023:{1:14580,2:19720,3:24860,4:3e4,5:35140,6:40280,7:45420,8:50560},2024:{1:15060,2:20440,3:25820,4:31200,5:36580,6:41960,7:47340,8:52720},2025:{1:15650,2:21150,3:26650,4:32150,5:37650,6:43150,7:48650,8:54150},2026:{1:16e3,2:21600,3:27200,4:32800,5:38400,6:44e3,7:49600,8:55200}},Pe={2023:5140,2024:5380,2025:5500,2026:5600};function Oe(t,e){const a=t-1,n=we[a]||we[2024],o=Pe[a]||Pe[2024];return e<=8?n[e]||n[1]:n[8]+(e-8)*o}function ke(t){const e=Math.round(t);return console.log(`[FORM 8962] Applicable % lookup: raw FPL%=${t.toFixed(2)}, rounded=${e}`),e<100||e<150?0:e<200?(e-150)/50*.02:e<250?.02+(e-200)/50*.02:e<300?.04+(e-250)/50*.02:e<400?.06+(e-300)/100*.025:.085}const Be=[{maxFplPercent:200,limits:{single:375,other:750}},{maxFplPercent:300,limits:{single:950,other:1900}},{maxFplPercent:400,limits:{single:1575,other:3150}}],Ne=[{maxFplPercent:200,limits:{single:400,other:800}},{maxFplPercent:300,limits:{single:1e3,other:2e3}},{maxFplPercent:400,limits:{single:1650,other:3300}}],ve=[{maxFplPercent:200,limits:{single:425,other:850}},{maxFplPercent:300,limits:{single:1050,other:2100}},{maxFplPercent:400,limits:{single:1725,other:3450}}];function $e(t){return t===2024?Be:t===2025?Ne:ve}function Ue(t,e,a){if(e>=400)return null;const n=$e(t),o=a==="single"||a==="married_filing_separately";for(const s of n)if(e<s.maxFplPercent)return o?s.limits.single:s.limits.other;return null}function je(t){const{taxYear:e,householdIncome:a,familySize:n,filingStatus:o,form1095AData:s}=t,r=Oe(e,n),l=a/r*100,h=ke(l),T=a*h,I=T/12;let m=0,D=0,_=0,S=0;for(const g of s)m+=g.annualPremium,D+=g.annualSlcsp,_+=g.annualAptc,S=Math.max(S,g.coverageMonths||12);let C=0;const q=Math.round(I);if(s.length>0&&s[0].monthlyPremiums?.length===12)for(let g=0;g<12;g++){let R=0,b=0;for(const y of s)R+=y.monthlyPremiums?.[g]||0,b+=y.monthlySlcsp?.[g]||0;if(R>0&&b>0){const y=Math.max(0,b-q),F=Math.min(R,y);C+=F}}else{const g=S||12,R=m/g,b=D/g;for(let y=0;y<g;y++){const F=Math.max(0,b-q),B=Math.min(R,F);C+=B}}C=Math.round(C);const w=C-_;let P=0,X=0,M=0,E=null;return w>=0?X=w:(P=Math.abs(w),E=Ue(e,l,o),E!==null?M=Math.min(P,E):M=P),{householdIncome:a,familySize:n,federalPovertyLevel:r,incomeAsFplPercent:Math.round(l*10)/10,applicablePercentage:Math.round(h*1e4)/100,annualContributionAmount:Math.round(T),monthlyContribution:Math.round(I*100)/100,totalAnnualPremium:m,totalAnnualSlcsp:D,totalAnnualAptc:_,coverageMonths:S||12,annualPtcAllowed:C,netPtc:w,excessAptc:P,repaymentLimitation:E,excessAptcRepayment:M,additionalPtc:X,line11_annualContribution:Math.round(T),line24_totalPtcAllowed:C,line25_totalAptc:_,line26_netPtc:X,line27_excessAptc:P,line28_repaymentLimitation:E,line29_excessAptcRepayment:M}}function Je(t){const e=(t.drakeFormType||"").toLowerCase(),a=(t.documentType||"").toLowerCase();if(e==="1095_a"||e==="1095-a"||e==="form_1095_a"||e==="form_1095-a"||a==="1095_a"||a==="1095-a"||a==="form_1095_a"||a==="form_1095-a"||a==="1095a"||a.includes("1095-a")||a.includes("1095_a")||a.includes("1095"))return!0;const n=t.extractedAmounts;return!!(n&&(n.annualPremiumAmount||n.annualSlcspPremium||n.annualAdvancePtc))}function De(t,e,a,n,o){const s=o.filter(l=>Je(l)&&l.extractedAmounts);if(console.log("[FORM 8962] Checking documents for 1095-A..."),console.log("[FORM 8962] Total documents:",o.length),console.log("[FORM 8962] Found 1095-A documents:",s.length),s.length>0&&s.forEach((l,h)=>{console.log(`[FORM 8962] 1095-A #${h+1}:`,{drakeFormType:l.drakeFormType,documentType:l.documentType,extractedAmounts:l.extractedAmounts})}),s.length===0)return console.log("[FORM 8962] No 1095-A documents found with extracted amounts"),null;const r=s.map(l=>({annualPremium:l.extractedAmounts?.annualPremiumAmount||0,annualSlcsp:l.extractedAmounts?.annualSlcspPremium||0,annualAptc:l.extractedAmounts?.annualAdvancePtc||0,monthlyPremiums:l.extractedAmounts?.monthlyPremiums,monthlySlcsp:l.extractedAmounts?.monthlySlcsp,monthlyAptc:l.extractedAmounts?.monthlyAptc,coverageMonths:l.extractedAmounts?.coverageMonths}));return console.log("[FORM 8962] Extracted 1095-A data:",r),je({taxYear:t,householdIncome:e,familySize:a,filingStatus:n,form1095AData:r})}const et=async t=>{try{const e=d.state.profile;e?.uid;const a=Date.now(),n={...t,id:Ce(),businessId:d.getBusinessId(),createdAt:a,updatedAt:a,createdBy:e.uid,documentCount:0,verifiedDocumentCount:0},o={query:"addTaxPortal",params:{businessId:d.getBusinessId()},form:n};return u("Creating tax portal:",o),(await p(o))?.taxPortal||n}catch(e){throw u("Error creating tax portal:",e),new Error("Error al crear el portal de impuestos")}},tt=async t=>{try{if(!d.state.user)throw new Error("Usuario no autenticado");let a={businessId:d.getBusinessId()};t&&t.trim();let r=((await p({query:"getTaxPortal",params:a}))?.data||[]).filter(l=>l.type==="document"||l.type==="checklist"?!1:l.firstName||l.lastName);if(!d.isAdmin()){const l=d.getAllowedStoreIds();r=r.filter(h=>h.storeId?l.includes(h.storeId):!0)}return r}catch(e){return u("Error getting tax portals:",e),[]}},at=async t=>{try{const e={query:"getTaxPortal",params:{businessId:d.getBusinessId(),id:t}},a=await p(e);return(a?.data?.taxPortal||a?.data||a?.taxPortal).filter(s=>s.id===t)?.[0]||null}catch(e){return u("Error getting tax portal:",e),null}},nt=async(t,e)=>{try{const a={query:"updateTaxPortal",params:{businessId:d.getBusinessId(),id:t},form:{...e,updatedAt:Date.now()}};return(await p(a))?.taxPortal||{id:t,...e}}catch(a){throw u("Error updating tax portal:",a),new Error("Error al actualizar el portal de impuestos")}},st=async t=>{try{const e={query:"deleteTaxPortal",params:{businessId:d.getBusinessId(),id:t}};await p(e)}catch(e){throw u("Error deleting tax portal:",e),new Error("Error al eliminar el portal de impuestos")}},We=()=>{const t=Date.now().toString(36),e=Math.random().toString(36).substring(2,12);return`TDR-${t}-${e}`.toUpperCase()},ze=()=>Math.floor(1e5+Math.random()*9e5).toString(),Ye=(t,e)=>{const a=`${window.location.origin}/#/tax-upload/${t}/${e}`;return`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(a)}`},ot=async(t,e)=>{try{const a=d.state.profile;a?.uid;const n=Date.now(),o=e.expirationDays||30,s=We(),r=Ce(),l={id:r,title:e?.task?.title,taxPortalId:t?.id,recipientName:`${t?.firstName} ${t?.lastName}`.trim(),clientName:`${t?.firstName} ${t?.lastName}`.trim(),clientEmail:t?.email,recipientEmail:t?.email,clientPhone:t?.phone,accessToken:s,accessPin:ze(),qrCodeUrl:Ye(r,s),taxYear:e.taxYear,requestedDocuments:e.requestedDocuments||[...Fe],instructions:e.instructions,status:"pending",uploadedDocuments:[],createdAt:n,expiresAt:n+o*24*60*60*1e3,requestedBy:a.uid,requestedByName:a.displayName||a.email||"Unknown",businessId:d.getBusinessId()||"",storeId:t?.storeId,storeName:t?.storeName},h={query:"addTaxDocumentRequest",params:{businessId:d.getBusinessId()},form:l};return(await p(h))?.documentRequest||l}catch(a){throw u("Error creating document request:",a),new Error("Error al crear la solicitud de documentos")}},Qe=async(t,e,a)=>{try{const s=(await U({query:"getTaxDocumentRequestByToken",params:{accessToken:e,id:t,verifySignature:a}}))?.data;if(!s)return null;s.expiresAt<Date.now()&&s.status==="pending"&&(s.status="expired");try{await ye(s.id,s.businessId)}catch{}return s}catch(n){return u("Error getting document request by token:",n),null}},rt=async(t,e)=>{try{const a=await Qe(t,e);if(!a||!a.taxPortalId)return null;const n={query:"getTaxPortalPublic",params:{id:a.taxPortalId,requestId:t,accessToken:e}},o=await U(n);return o?.data?.[0]||o?.data||null}catch(a){return u("Error getting tax portal by request:",a),null}},it=async(t,e,a)=>{try{const s=(await U({query:"getSignatureValidationByToken",params:{accessToken:e,id:t,verifySignature:a}}))?.data;if(!s)return null;s.expiresAt<Date.now()&&s.status==="pending"&&(s.status="expired");try{await ye(s.id,s.businessId)}catch{}return s}catch(n){return u("Error getting document request by token:",n),null}},lt=async t=>{try{const n=(await p({query:"getTaxDocumentRequestByPin",params:{accessPin:t}}))?.documentRequest;if(!n)return null;n.expiresAt<Date.now()&&n.status==="pending"&&(n.status="expired");try{await ye(n.id,n.businessId)}catch{}return n}catch(e){return u("Error getting document request by PIN:",e),null}},ye=async(t,e)=>{const a={query:"updateTaxDocumentRequestLastAccess",params:{businessId:e,id:t},form:{lastAccessedAt:Date.now()}};await U(a)},ct=async t=>{try{const e={query:"getTaxDocumentRequestsByRecipient",params:{businessId:d.getBusinessId(),recipientId:t}},a=await p(e);return a?.data?.data||a?.data||[]}catch(e){return u("Error getting document requests:",e),[]}},dt=async t=>{try{if(!d.state.user)throw new Error("Usuario no autenticado");const a={query:"getTaxDocumentRequests",params:{businessId:d.getBusinessId()}},n=await p(a);let o=n?.data?.data||n?.data||[];if(!d.isAdmin()){const s=d.getAllowedStoreIds();o=o.filter(r=>r.storeId?s.includes(r.storeId):!0)}return t?.status,t?.taxYear,o.sort((s,r)=>r.createdAt-s.createdAt),o}catch(e){return u("Error getting document requests:",e),[]}},ut=async(t,e,a,n)=>{try{const r=(await p({query:"getTaxDocumentRequestById",params:{businessId:e,id:t}}))?.documentRequest;if(!r)throw new Error("Request not found");const l=r.requestedDocuments.map(m=>m.type===a?{...m,uploaded:!0,documentId:n}:m),h=l.filter(m=>m.required).every(m=>m.uploaded),T=l.some(m=>m.uploaded),I={query:"updateTaxDocumentRequest",params:{businessId:e,id:t},form:{requestedDocuments:l,uploadedDocuments:[...r.uploadedDocuments||[],n],status:h?"complete":T?"partial":"pending"}};await p(I)}catch(o){throw u("Error marking document uploaded:",o),o}},mt=async t=>{try{const e={query:"updateTaxDocumentRequest",params:{businessId:d.getBusinessId(),id:t},form:{status:"cancelled"}};await p(e)}catch(e){throw u("Error cancelling document request:",e),new Error("Error al cancelar la solicitud")}},ht=async t=>{try{const e={query:"deleteTaxDocumentRequest",params:{businessId:d.getBusinessId(),id:t}};await p(e)}catch(e){throw u("Error deleting document request:",e),new Error("Error al eliminar la solicitud")}},gt=async t=>{try{const e={query:"sendTaxDocumentRequestReminder",params:{businessId:d.getBusinessId(),id:t}},a=await p(e);a?.success&&await p({query:"updateTaxDocumentRequest",params:{businessId:d.getBusinessId(),id:t},form:{remindersSent:(a.remindersSent||0)+1}})}catch(e){throw u("Error sending reminder:",e),new Error("Error al enviar el recordatorio")}},pt=async(t,e,a,n)=>{try{const o={query:"markDocumentNotNeeded",params:{businessId:d.getBusinessId(),id:t,documentType:e,notNeeded:a,reason:n,markedBy:"accountant",markedAt:Date.now()}},s=await p(o);return{success:!0}}catch(o){return u("Error marking document as not needed:",o),{success:!1,error:"Error updating document status"}}},At=t=>`${window.location.origin}/#/tax-upload/${t}`,ft=()=>`${window.location.origin}/#/tax-upload-pin`,Ct=t=>{const e=Date.now(),a=t-e;if(a<=0)return"Expirado";const n=Math.floor(a/(24*60*60*1e3)),o=Math.floor(a%(24*60*60*1e3)/(60*60*1e3));return n>0?`${n} día${n>1?"s":""} restante${n>1?"s":""}`:`${o} hora${o>1?"s":""} restante${o>1?"s":""}`},yt=t=>t.expiresAt<Date.now(),Tt=t=>{const e=t.requestedDocuments.length,a=t.requestedDocuments.filter(n=>n.uploaded).length;return Math.round(a/e*100)},bt=t=>t.requestedDocuments.filter(e=>e.required&&!e.uploaded),Lt=async(t,e,a,n)=>{try{const o=await U({query:"updateTaxDocumentRequest",params:{requestId:t,id:t,accessToken:e,businessId:n},form:a});return{success:!0}}catch(o){return u("Error updating document request:",o),{success:!1,error:o.message}}};async function xt(t,e,a,n){try{const o=await t.arrayBuffer(),s=Array.from(new Uint8Array(o)),r=await U({query:"uploadTaxDocument",params:{businessId:n?.businessId||d.getBusinessId()},form:{fileBuffer:s,fileName:t.name,mimeType:t.type,fileSize:t.size,taxPortalId:e,taxYear:a,businessId:n?.businessId||d.getBusinessId(),documentType:n?.documentType,tags:n?.tags,notes:n?.notes}});return r?.success&&r?.documentId?{success:!0,documentId:r.documentId,document:r.document}:{success:!1,error:r?.error||"Failed to upload document"}}catch(o){return u("Error uploading tax document:",o),{success:!1,error:o.message}}}const Ge=t=>{const e={2024:{taxYear:2024,standardDeductions:{single:14600,married_jointly:29200,married_separately:14600,head_of_household:21900,qualifying_widow:29200},taxBrackets:{single:[{limit:11600,rate:.1,base:0,threshold:0},{limit:47150,rate:.12,base:1160,threshold:11600},{limit:100525,rate:.22,base:5426,threshold:47150},{limit:191950,rate:.24,base:17168.5,threshold:100525},{limit:243725,rate:.32,base:39110.5,threshold:191950},{limit:609350,rate:.35,base:55678.5,threshold:243725},{limit:1/0,rate:.37,base:183647.25,threshold:609350}],married_jointly:[{limit:23200,rate:.1,base:0,threshold:0},{limit:94300,rate:.12,base:2320,threshold:23200},{limit:201050,rate:.22,base:10852,threshold:94300},{limit:383900,rate:.24,base:34337,threshold:201050},{limit:487450,rate:.32,base:78221,threshold:383900},{limit:731200,rate:.35,base:111357,threshold:487450},{limit:1/0,rate:.37,base:196669.5,threshold:731200}],married_separately:[{limit:11600,rate:.1,base:0,threshold:0},{limit:47150,rate:.12,base:1160,threshold:11600},{limit:100525,rate:.22,base:5426,threshold:47150},{limit:191950,rate:.24,base:17168.5,threshold:100525},{limit:243725,rate:.32,base:39110.5,threshold:191950},{limit:365600,rate:.35,base:55678.5,threshold:243725},{limit:1/0,rate:.37,base:98334.75,threshold:365600}],head_of_household:[{limit:16550,rate:.1,base:0,threshold:0},{limit:63100,rate:.12,base:1655,threshold:16550},{limit:100500,rate:.22,base:7241,threshold:63100},{limit:191950,rate:.24,base:15469,threshold:100500},{limit:243700,rate:.32,base:37417,threshold:191950},{limit:609350,rate:.35,base:53977,threshold:243700},{limit:1/0,rate:.37,base:181954.5,threshold:609350}]},saltCap:1e4,saltCapMFS:5e3,additionalDeduction65Plus:{single:1950,married:1550},eitcBrackets:{0:{maxCredit:632,phaseInEnd:7840,phaseOutStartSingle:9800,phaseOutStartMFJ:16370,singleLimit:18591,mfjLimit:25511,phaseInRate:.0765,phaseOutRate:.0765},1:{maxCredit:4213,phaseInEnd:12390,phaseOutStartSingle:22720,phaseOutStartMFJ:29290,singleLimit:49084,mfjLimit:56004,phaseInRate:.34,phaseOutRate:.1598},2:{maxCredit:6960,phaseInEnd:17400,phaseOutStartSingle:22720,phaseOutStartMFJ:29290,singleLimit:55768,mfjLimit:62688,phaseInRate:.4,phaseOutRate:.2106},3:{maxCredit:7830,phaseInEnd:17400,phaseOutStartSingle:22720,phaseOutStartMFJ:29290,singleLimit:59899,mfjLimit:66819,phaseInRate:.45,phaseOutRate:.2106}},childTaxCredit:{amountPerChild:2e3,maxRefundablePerChild:1700,phaseOutThresholdSingle:2e5,phaseOutThresholdMFJ:4e5}},2025:{taxYear:2025,standardDeductions:{single:15750,married_jointly:31500,married_separately:15750,head_of_household:23625,qualifying_widow:31500},taxBrackets:{single:[{limit:11925,rate:.1,base:0,threshold:0},{limit:48475,rate:.12,base:1192.5,threshold:11925},{limit:103350,rate:.22,base:5578.5,threshold:48475},{limit:197300,rate:.24,base:17651,threshold:103350},{limit:250525,rate:.32,base:40199,threshold:197300},{limit:626350,rate:.35,base:57231,threshold:250525},{limit:1/0,rate:.37,base:188769.75,threshold:626350}],married_jointly:[{limit:23850,rate:.1,base:0,threshold:0},{limit:96950,rate:.12,base:2385,threshold:23850},{limit:206700,rate:.22,base:11157,threshold:96950},{limit:394600,rate:.24,base:35302,threshold:206700},{limit:501050,rate:.32,base:80398,threshold:394600},{limit:751600,rate:.35,base:114462,threshold:501050},{limit:1/0,rate:.37,base:202154.5,threshold:751600}],married_separately:[{limit:11925,rate:.1,base:0,threshold:0},{limit:48475,rate:.12,base:1192.5,threshold:11925},{limit:103350,rate:.22,base:5578.5,threshold:48475},{limit:197300,rate:.24,base:17651,threshold:103350},{limit:250525,rate:.32,base:40199,threshold:197300},{limit:375800,rate:.35,base:57231,threshold:250525},{limit:1/0,rate:.37,base:101077.25,threshold:375800}],head_of_household:[{limit:17e3,rate:.1,base:0,threshold:0},{limit:64850,rate:.12,base:1700,threshold:17e3},{limit:103350,rate:.22,base:7442,threshold:64850},{limit:197300,rate:.24,base:15912,threshold:103350},{limit:250500,rate:.32,base:38460,threshold:197300},{limit:626350,rate:.35,base:55484,threshold:250500},{limit:1/0,rate:.37,base:187032,threshold:626350}]},saltCap:1e4,saltCapMFS:5e3,additionalDeduction65Plus:{single:2e3,married:1600},eitcBrackets:{0:{maxCredit:649,phaseInEnd:8490,phaseOutStartSingle:10620,phaseOutStartMFJ:17620,singleLimit:19104,mfjLimit:26214,phaseInRate:.0765,phaseOutRate:.0765},1:{maxCredit:4328,phaseInEnd:12730,phaseOutStartSingle:23350,phaseOutStartMFJ:30350,singleLimit:50434,mfjLimit:57554,phaseInRate:.34,phaseOutRate:.1598},2:{maxCredit:7152,phaseInEnd:17880,phaseOutStartSingle:23350,phaseOutStartMFJ:30350,singleLimit:57310,mfjLimit:64430,phaseInRate:.4,phaseOutRate:.2106},3:{maxCredit:8046,phaseInEnd:17880,phaseOutStartSingle:23350,phaseOutStartMFJ:30350,singleLimit:61555,mfjLimit:68675,phaseInRate:.45,phaseOutRate:.2106}},childTaxCredit:{amountPerChild:2200,maxRefundablePerChild:1700,phaseOutThresholdSingle:2e5,phaseOutThresholdMFJ:4e5}}};return e[t]||e[2025]},He={single:"Single",married_filing_jointly:"Married Filing Jointly",married_jointly:"Married Filing Jointly",married_filing_separately:"Married Filing Separately",married_separate:"Married Filing Separately",head_of_household:"Head of Household",head_household:"Head of Household",qualifying_widow:"Qualifying Surviving Spouse"},Ke=t=>({married_jointly:"married_jointly",married_filing_jointly:"married_jointly",married_separate:"married_separately",married_filing_separately:"married_separately",head_household:"head_of_household",head_of_household:"head_of_household",single:"single",qualifying_widow:"qualifying_widow"})[t]||"single",It=async(t,e,a,n,o)=>{console.log("[TAX CALC] ===== TAX CALCULATION STARTED ====="),console.log("[TAX CALC] Client:",JSON.stringify({id:t,name:`${n.firstName} ${n.lastName}`,filingStatus:n.filingStatus,taxYear:e,dependentsCount:n.dependents?.length||0})),console.log("[TAX CALC] Documents count:",a.length);const s=Ge(e),r=Ke(n.filingStatus||"single"),l=r==="married_separately";console.log("[TAX CALC] Filing status:",r),console.log("[TAX CALC] Tax year constants:",JSON.stringify({standardDeductions:s.standardDeductions,saltCap:s.saltCap,saltCapMFS:s.saltCapMFS}));let h=0,T=0,I=0,m=0,D=0,_=0,S=0,C=0,q=0,w=0,P=0,X=0,M=0,E=0,g=0,R=0;console.log("[TAX CALC] --- Processing Documents ---"),a.forEach((i,A)=>{if(console.log(`[TAX CALC] Doc ${A+1}: type=${i.drakeFormType||i.documentType} | verified=${i.verified} | hasAmounts=${!!i.extractedAmounts} | file=${i.originalFileName}`),i.verified&&i.extractedAmounts){const c=i.extractedAmounts;console.log(`[TAX CALC] Doc ${A+1} extractedAmounts:`,JSON.stringify(c)),c.wages&&(h+=c.wages),c.interestIncome&&(I+=c.interestIncome),c.ordinaryDividends&&(m+=c.ordinaryDividends),c.nonEmployeeCompensation&&(D+=c.nonEmployeeCompensation),c.rents&&(_+=c.rents),c.royalties&&(S+=c.royalties),c.otherIncome&&(C+=c.otherIncome),c.federalTaxWithheld&&(q+=c.federalTaxWithheld),c.federalTaxWithheld1099&&(w+=c.federalTaxWithheld1099),c.stateTaxWithheld&&(P+=c.stateTaxWithheld),c.localTaxWithheld&&(X+=c.localTaxWithheld),c.propertyTaxes&&(M+=c.propertyTaxes),c.mortgageInterest&&(E+=c.mortgageInterest),c.pointsPaid&&(g+=c.pointsPaid),c.mortgageInsurancePremiums&&(R+=c.mortgageInsurancePremiums)}});const b=h+T,y=D+_+S+C,F=b+I+m+y,B=q+w;console.log("[TAX CALC] --- Income Summary ---"),console.log("[TAX CALC] Line 1a (Wages):",h),console.log("[TAX CALC] Line 1h (Other earned):",T),console.log("[TAX CALC] Line 1z (Total wages):",b),console.log("[TAX CALC] Line 2b (Taxable interest):",I),console.log("[TAX CALC] Line 3b (Ordinary dividends):",m),console.log("[TAX CALC] Line 8 breakdown:",JSON.stringify({business:D,rental:_,royalties:S,other:C})),console.log("[TAX CALC] Line 8 (Other income total):",y),console.log("[TAX CALC] Line 9 (TOTAL INCOME):",F),console.log("[TAX CALC] Line 25a (W-2 withholding):",q),console.log("[TAX CALC] Line 25b (1099 withholding):",w),console.log("[TAX CALC] Line 25d (Total withholding):",B);const G=s.standardDeductions[r]||s.standardDeductions.single,Te=l?s.saltCapMFS:s.saltCap,be=P+X+M,ee=Math.min(be,Te),te=E+g+R,Le=0,H=ee+te+Le,ae=H>G,ne=ae?H:G,se=o?.qbid||0,oe=o?.schedule1ADeductions||0,re=ne+se+oe,ie=0,L=F-ie,K=Math.max(0,L-re);console.log("[TAX CALC] --- Deductions ---"),console.log("[TAX CALC] SALT breakdown:",JSON.stringify({state:P,local:X,property:M,total:be})),console.log("[TAX CALC] SALT cap:",Te),console.log("[TAX CALC] SALT deduction (capped):",ee),console.log("[TAX CALC] Mortgage interest:",te),console.log("[TAX CALC] Itemized total:",H),console.log("[TAX CALC] Standard deduction:",G),console.log("[TAX CALC] Line 12e (Std/Itemized):",ae?"ITEMIZED":"STANDARD","=",ne),console.log("[TAX CALC] Line 13a (QBID):",se),console.log("[TAX CALC] Line 13b (Schedule 1-A):",oe),console.log("[TAX CALC] Line 14 (Total deductions):",re),console.log("[TAX CALC] Line 10 (Adjustments):",ie),console.log("[TAX CALC] Line 11 (AGI):",L),console.log("[TAX CALC] Line 15 (TAXABLE INCOME):",K);let j;r==="married_jointly"||r==="qualifying_widow"?j=s.taxBrackets.married_jointly:r==="head_of_household"?j=s.taxBrackets.head_of_household:r==="married_separately"?j=s.taxBrackets.married_separately:j=s.taxBrackets.single;let N=0,le="",ce=0;for(const i of j)if(K<=i.limit){N=i.base+(K-i.threshold)*i.rate,ce=i.rate,le=`${(i.rate*100).toFixed(0)}% bracket ($${i.threshold.toLocaleString()} - $${i.limit===1/0?"∞":i.limit.toLocaleString()})`;break}const de=1+(r==="married_jointly"?1:0)+(n.dependents?.length||0);let f=De(e,L,de,r,a);if(!f&&n.taxStrategy?.otherIncome?.healthInsuranceMarketplace){const i=n.taxStrategy.otherIncome.healthInsuranceMarketplace;if(i.hasMarketplaceCoverage&&i.coverageMonths>0){console.log("[TAX CALC] No 1095-A document found, using Strategy health insurance marketplace data"),console.log("[TAX CALC] Marketplace data:",JSON.stringify(i));const A={drakeFormType:"1095_a",documentType:"1095_a",extractedAmounts:{annualPremiumAmount:i.monthlyPremium*i.coverageMonths,annualSlcspPremium:i.monthlySlcsp*i.coverageMonths,annualAdvancePtc:i.monthlyAptc*i.coverageMonths,coverageMonths:i.coverageMonths}};f=De(e,L,de,r,[A])}}f&&(console.log("[TAX CALC] --- Form 8962 Premium Tax Credit ---"),console.log("[TAX CALC] Family size:",de),console.log("[TAX CALC] Income as % FPL:",f.incomeAsFplPercent+"%"),console.log("[TAX CALC] Applicable %:",f.applicablePercentage+"%"),console.log("[TAX CALC] Annual PTC allowed:",f.annualPtcAllowed),console.log("[TAX CALC] Total APTC received:",f.totalAnnualAptc),console.log("[TAX CALC] Excess APTC:",f.excessAptc),console.log("[TAX CALC] Repayment limitation:",f.repaymentLimitation),console.log("[TAX CALC] Line 29 (Excess repayment):",f.excessAptcRepayment),console.log("[TAX CALC] Additional PTC credit:",f.additionalPtc));const Me=o?.schedule2Tax||0,Ee=f?.excessAptcRepayment||0,ue=Me+Ee,me=N+ue;console.log("[TAX CALC] --- Tax Calculation ---"),console.log("[TAX CALC] Brackets used for:",r),console.log("[TAX CALC] Bracket:",le),console.log("[TAX CALC] Line 16 (Tax from brackets):",N),console.log("[TAX CALC] Line 17 (Schedule 2 taxes):",ue),console.log("[TAX CALC] Line 18 (Total tax before credits):",me),console.log("[TAX CALC] Marginal rate:",(ce*100).toFixed(0)+"%");const Re=["son","daughter","stepson","stepdaughter","foster_child","grandchild"],he=new Date(e,11,31),V=(n.dependents||[]).filter(i=>{if(!Re.includes(i.relationship))return!1;if(i.dateOfBirth){const A=new Date(i.dateOfBirth);return he.getFullYear()-A.getFullYear()-(he<new Date(he.getFullYear(),A.getMonth(),A.getDate())?1:0)<17}return!0});console.log("[TAX CALC] --- Credits Calculation ---"),console.log("[TAX CALC] Total dependents:",n.dependents?.length||0),console.log("[TAX CALC] Qualifying children (under 17):",V.length),console.log("[TAX CALC] Dependents detail:",JSON.stringify(n.dependents?.map(i=>({name:`${i.firstName} ${i.lastName}`,relationship:i.relationship,dob:i.dateOfBirth}))));const J=s.childTaxCredit,qe=J.amountPerChild,ge=r==="married_jointly"?J.phaseOutThresholdMFJ:J.phaseOutThresholdSingle;let W=V.length*qe;if(L>ge){const i=L-ge,A=Math.ceil(i/1e3)*50;W=Math.max(0,W-A),console.log("[TAX CALC] CTC phase-out: AGI",L,"> threshold",ge,", reduction:",A)}const z=Math.min(W,me),Z=Math.min(V.length*J.maxRefundablePerChild,W-z);console.log("[TAX CALC] Child Tax Credit constants:",JSON.stringify(J)),console.log("[TAX CALC] Child Tax Credit (before limit):",W),console.log("[TAX CALC] Non-refundable CTC (limited to Line 18 tax):",z),console.log("[TAX CALC] Additional Child Tax Credit (refundable):",Z);const Y=b,xe=r==="married_jointly",Ie=Math.min(V.length,3),x=s.eitcBrackets[Ie],_e=xe?x.mfjLimit:x.singleLimit,Q=xe?x.phaseOutStartMFJ:x.phaseOutStartSingle,v=Math.max(Y,L);let O=0,$="";if(Y<=0)O=0,$="no-income";else if(v>_e)O=0,$="over-limit";else{const i=Math.min(Y*x.phaseInRate,x.maxCredit);let A=0;v>Q&&(A=(v-Q)*x.phaseOutRate),O=Math.max(0,Math.floor(i-A)),Y<=x.phaseInEnd&&v<=Q?$="phase-in":v<=Q?$="plateau":$="phase-out",console.log("[TAX CALC] EIC Phase-in credit:",i.toFixed(2),"| Phase-out reduction:",A.toFixed(2))}console.log("[TAX CALC] EITC constants for",e,":",JSON.stringify(x)),console.log("[TAX CALC] Earned income for EIC:",Y,"| AGI:",L,"| Income for phase-out:",v),console.log("[TAX CALC] EIC bracket:",Ie,"children | Phase-in end:",x.phaseInEnd,"| Phase-out start:",Q,"| Max income:",_e),console.log("[TAX CALC] EIC phase:",$,"| Final credit:",O);const pe=z,Ae=Math.max(0,N-pe),Xe=Z+O,fe=B+Xe,k=fe-Ae;console.log("[TAX CALC] --- Final Calculation ---"),console.log("[TAX CALC] Line 16 (Tax before credits):",N),console.log("[TAX CALC] Line 19 (Child Tax Credit):",z),console.log("[TAX CALC] Line 21 (Total non-refundable credits):",pe),console.log("[TAX CALC] Line 24 (Total tax after credits):",Ae),console.log("[TAX CALC] Line 25d (Withholding):",B),console.log("[TAX CALC] Line 27 (EIC - refundable):",O),console.log("[TAX CALC] Line 28 (ACTC - refundable):",Z),console.log("[TAX CALC] Line 33 (Total payments + refundable credits):",fe),console.log("[TAX CALC] RESULT:",k>0?`REFUND $${k.toFixed(2)}`:`OWED $${Math.abs(k).toFixed(2)}`);const Se={id:Ce(),taxPortalId:t,taxYear:e,filingStatus:r,filingStatusLabel:He[n.filingStatus||"single"]||"Single",calculatedAt:Date.now(),line1a_wages:h,line1h_otherEarnedIncome:T,line1z_totalWages:b,line2b_taxableInterest:I,line3b_ordinaryDividends:m,line8_otherIncome:y,line8_breakdown:{businessIncome:D,rentalIncome:_,royalties:S,other:C},line9_totalIncome:F,line10_adjustments:ie,line11_agi:L,line12a_standardDeduction:G,line12b_itemizedDeductions:H,line12b_breakdown:{saltDeduction:ee,mortgageInterest:te,charitableContributions:Le},line12_deductionUsed:ae?"itemized":"standard",line12_deductionAmount:ne,line13a_qbid:se,line13b_schedule1ADeductions:oe,line14_totalDeductions:re,line15_taxableIncome:K,line16_tax:N,line16_bracketUsed:le,line16_marginalRate:ce,line17_schedule2Tax:ue,line18_totalTaxBeforeCredits:me,line19_childTaxCredit:z,line21_totalCredits:pe,line24_totalTax:Ae,line25a_w2Withholding:q,line25b_1099Withholding:w,line25d_totalWithholding:B,line27_eic:O,line28_actc:Z,line33_totalPayments:fe,line34_refund:k>0?k:0,line37_amountOwed:k<0?Math.abs(k):0,form8962:f||void 0};return console.log("[TAX CALC] ===== FULL RESULT ====="),console.log("[TAX CALC]",JSON.stringify(Se,null,2)),console.log("[TAX CALC] ===== TAX CALCULATION COMPLETE ====="),Se};export{Tt as a,At as b,ft as c,ot as d,mt as e,Ct as f,ct as g,ht as h,yt as i,tt as j,dt as k,et as l,st as m,pt as n,It as o,at as p,Qe as q,bt as r,gt as s,Lt as t,nt as u,xt as v,ut as w,lt as x,rt as y,it as z};
