import{aB as m,g as a,O as c,P as g}from"./index-YmMNRf0g.js";import{a as w}from"./drakeTypes-DcjcYEfx.js";const x=async e=>{try{const r=a.state.profile;r?.uid;const t=Date.now(),s={...e,id:g(),businessId:a.getBusinessId(),createdAt:t,updatedAt:t,createdBy:r.uid,documentCount:0,verifiedDocumentCount:0},o={query:"addTaxPortal",params:{businessId:a.getBusinessId()},form:s};return console.log("Creating tax portal:",o),(await c(o))?.taxPortal||s}catch(r){throw console.error("Error creating tax portal:",r),new Error("Error al crear el portal de impuestos")}},E=async e=>{try{if(!a.state.user)throw new Error("Usuario no autenticado");let t={businessId:a.getBusinessId()};e&&e.trim();let u=((await c({query:"getTaxPortal",params:t}))?.data||[]).filter(d=>d.type==="document"||d.type==="checklist"?!1:d.firstName||d.lastName);if(!a.isAdmin()){const d=a.getAllowedStoreIds();u=u.filter(l=>l.storeId?d.includes(l.storeId):!0)}return u}catch(r){return console.error("Error getting tax portals:",r),[]}},R=async e=>{try{const r={query:"getTaxPortal",params:{businessId:a.getBusinessId(),id:e}},t=await c(r);return(t?.data?.taxPortal||t?.data||t?.taxPortal).filter(n=>n.id===e)?.[0]||null}catch(r){return console.error("Error getting tax portal:",r),null}},T=async(e,r)=>{try{const t={query:"updateTaxPortal",params:{businessId:a.getBusinessId(),id:e},form:{...r,updatedAt:Date.now()}};return(await c(t))?.taxPortal||{id:e,...r}}catch(t){throw console.error("Error updating tax portal:",t),new Error("Error al actualizar el portal de impuestos")}},B=async e=>{try{const r={query:"deleteTaxPortal",params:{businessId:a.getBusinessId(),id:e}};await c(r)}catch(r){throw console.error("Error deleting tax portal:",r),new Error("Error al eliminar el portal de impuestos")}},f=()=>{const e=Date.now().toString(36),r=Math.random().toString(36).substring(2,12);return`TDR-${e}-${r}`.toUpperCase()},D=()=>Math.floor(1e5+Math.random()*9e5).toString(),I=(e,r)=>{const t=`${window.location.origin}/#/tax-upload/${e}/${r}`;return`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(t)}`},A=async(e,r)=>{try{const t=a.state.profile;t?.uid;const s=Date.now(),o=r.expirationDays||30,n=f(),u=g();console.log(e);const d={id:u,title:r?.task?.title,taxPortalId:e?.id,recipientName:`${e?.firstName} ${e?.lastName}`.trim(),clientName:`${e?.firstName} ${e?.lastName}`.trim(),clientEmail:e?.email,recipientEmail:e?.email,clientPhone:e?.phone,accessToken:n,accessPin:D(),qrCodeUrl:I(u,n),taxYear:r.taxYear,requestedDocuments:r.requestedDocuments||[...w],instructions:r.instructions,status:"pending",uploadedDocuments:[],createdAt:s,expiresAt:s+o*24*60*60*1e3,requestedBy:t.uid,requestedByName:t.displayName||t.email||"Unknown",businessId:a.getBusinessId()||"",storeId:e?.storeId,storeName:e?.storeName},l={query:"addTaxDocumentRequest",params:{businessId:a.getBusinessId()},form:d};return console.log("Creating document request:",l),(await c(l))?.documentRequest||d}catch(t){throw console.error("Error creating document request:",t),new Error("Error al crear la solicitud de documentos")}},U=async(e,r,t)=>{try{const n=(await m({query:"getTaxDocumentRequestByToken",params:{accessToken:r,id:e,verifySignature:t}}))?.data;if(!n)return null;n.expiresAt<Date.now()&&n.status==="pending"&&(n.status="expired");try{await p(n.id,n.businessId)}catch{}return n}catch(s){return console.error("Error getting document request by token:",s),null}},S=async(e,r,t)=>{try{const n=(await m({query:"getSignatureValidationByToken",params:{accessToken:r,id:e,verifySignature:t}}))?.data;if(!n)return null;n.expiresAt<Date.now()&&n.status==="pending"&&(n.status="expired");try{await p(n.id,n.businessId)}catch{}return n}catch(s){return console.error("Error getting document request by token:",s),null}},P=async e=>{try{const s=(await c({query:"getTaxDocumentRequestByPin",params:{accessPin:e}}))?.documentRequest;if(!s)return null;s.expiresAt<Date.now()&&s.status==="pending"&&(s.status="expired");try{await p(s.id,s.businessId)}catch{}return s}catch(r){return console.error("Error getting document request by PIN:",r),null}},p=async(e,r)=>{const t={query:"updateTaxDocumentRequestLastAccess",params:{businessId:r,id:e},form:{lastAccessedAt:Date.now()}};await m(t)},k=async e=>{try{const r={query:"getTaxDocumentRequestsByRecipient",params:{businessId:a.getBusinessId(),recipientId:e}},t=await c(r);return t?.data?.data||t?.data||[]}catch(r){return console.error("Error getting document requests:",r),[]}},N=async e=>{try{if(!a.state.user)throw new Error("Usuario no autenticado");const t={query:"getTaxDocumentRequests",params:{businessId:a.getBusinessId()}},s=await c(t);let o=s?.data?.data||s?.data||[];if(!a.isAdmin()){const n=a.getAllowedStoreIds();o=o.filter(u=>u.storeId?n.includes(u.storeId):!0)}return e?.status,e?.taxYear,o.sort((n,u)=>u.createdAt-n.createdAt),o}catch(r){return console.error("Error getting document requests:",r),[]}},$=async(e,r,t,s)=>{try{const u=(await c({query:"getTaxDocumentRequestById",params:{businessId:r,id:e}}))?.documentRequest;if(!u)throw new Error("Request not found");const d=u.requestedDocuments.map(i=>i.type===t?{...i,uploaded:!0,documentId:s}:i),l=d.filter(i=>i.required).every(i=>i.uploaded),y=d.some(i=>i.uploaded),q={query:"updateTaxDocumentRequest",params:{businessId:r,id:e},form:{requestedDocuments:d,uploadedDocuments:[...u.uploadedDocuments||[],s],status:l?"complete":y?"partial":"pending"}};await c(q)}catch(o){throw console.error("Error marking document uploaded:",o),o}},C=async e=>{try{const r={query:"updateTaxDocumentRequest",params:{businessId:a.getBusinessId(),id:e},form:{status:"cancelled"}};await c(r)}catch(r){throw console.error("Error cancelling document request:",r),new Error("Error al cancelar la solicitud")}},v=async e=>{try{const r={query:"deleteTaxDocumentRequest",params:{businessId:a.getBusinessId(),id:e}};await c(r)}catch(r){throw console.error("Error deleting document request:",r),new Error("Error al eliminar la solicitud")}},M=async e=>{try{const r={query:"sendTaxDocumentRequestReminder",params:{businessId:a.getBusinessId(),id:e}},t=await c(r);t?.success&&await c({query:"updateTaxDocumentRequest",params:{businessId:a.getBusinessId(),id:e},form:{remindersSent:(t.remindersSent||0)+1}})}catch(r){throw console.error("Error sending reminder:",r),new Error("Error al enviar el recordatorio")}},L=async(e,r,t,s)=>{try{const o={query:"markDocumentNotNeeded",params:{businessId:a.getBusinessId(),id:e,documentType:r,notNeeded:t,reason:s,markedBy:"accountant",markedAt:Date.now()}},n=await c(o);return{success:!0}}catch(o){return console.error("Error marking document as not needed:",o),{success:!1,error:"Error updating document status"}}},z=e=>`${window.location.origin}/#/tax-upload/${e}`,Q=()=>`${window.location.origin}/#/tax-upload-pin`,Y=e=>{const r=Date.now(),t=e-r;if(t<=0)return"Expirado";const s=Math.floor(t/(24*60*60*1e3)),o=Math.floor(t%(24*60*60*1e3)/(60*60*1e3));return s>0?`${s} dÃ­a${s>1?"s":""} restante${s>1?"s":""}`:`${o} hora${o>1?"s":""} restante${o>1?"s":""}`},_=e=>e.expiresAt<Date.now(),F=e=>{const r=e.requestedDocuments.length,t=e.requestedDocuments.filter(s=>s.uploaded).length;return Math.round(t/r*100)},O=e=>e.requestedDocuments.filter(r=>r.required&&!r.uploaded),j=async(e,r,t,s)=>{try{const o=await m({query:"updateTaxDocumentRequest",params:{requestId:e,id:e,accessToken:r,businessId:s},form:t});return{success:!0}}catch(o){return console.error("Error updating document request:",o),{success:!1,error:o.message}}};async function G(e,r,t,s){try{const o=await e.arrayBuffer(),n=Array.from(new Uint8Array(o)),u=await m({query:"uploadTaxDocument",params:{businessId:s?.businessId||a.getBusinessId()},form:{fileBuffer:n,fileName:e.name,mimeType:e.type,fileSize:e.size,taxPortalId:r,taxYear:t,businessId:s?.businessId||a.getBusinessId(),documentType:s?.documentType,tags:s?.tags,notes:s?.notes}});return u?.success&&u?.documentId?{success:!0,documentId:u.documentId,document:u.document}:{success:!1,error:u?.error||"Failed to upload document"}}catch(o){return console.error("Error uploading tax document:",o),{success:!1,error:o.message}}}export{F as a,z as b,Q as c,A as d,C as e,Y as f,k as g,v as h,_ as i,E as j,N as k,x as l,B as m,L as n,R as o,U as p,O as q,j as r,M as s,G as t,T as u,$ as v,P as w,S as x};
