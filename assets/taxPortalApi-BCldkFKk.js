import{aB as m,g as n,O as u,P as y}from"./index-BF7AAaX4.js";import{a as w}from"./drakeTypes-B0Dixu81.js";const b=async e=>{try{const r=n.state.profile;r?.uid;const t=Date.now(),s={...e,id:y(),businessId:n.getBusinessId(),createdAt:t,updatedAt:t,createdBy:r.uid,documentCount:0,verifiedDocumentCount:0},o={query:"addTaxPortal",params:{businessId:n.getBusinessId()},form:s};return console.log("Creating tax portal:",o),(await u(o))?.taxPortal||s}catch(r){throw console.error("Error creating tax portal:",r),new Error("Error al crear el portal de impuestos")}},E=async e=>{try{if(!n.state.user)throw new Error("Usuario no autenticado");let t={businessId:n.getBusinessId()};e&&e.trim();let a=((await u({query:"getTaxPortal",params:t}))?.data||[]).filter(d=>d.type==="document"||d.type==="checklist"?!1:d.firstName||d.lastName);if(!n.isAdmin()){const d=n.getAllowedStoreIds();a=a.filter(l=>l.storeId?d.includes(l.storeId):!0)}return a}catch(r){return console.error("Error getting tax portals:",r),[]}},R=async e=>{try{const r={query:"getTaxPortal",params:{businessId:n.getBusinessId(),id:e}},t=await u(r);return(t?.data?.taxPortal||t?.data||t?.taxPortal).filter(c=>c.id===e)?.[0]||null}catch(r){return console.error("Error getting tax portal:",r),null}},T=async(e,r)=>{try{const t={query:"updateTaxPortal",params:{businessId:n.getBusinessId(),id:e},form:{...r,updatedAt:Date.now()}};return(await u(t))?.taxPortal||{id:e,...r}}catch(t){throw console.error("Error updating tax portal:",t),new Error("Error al actualizar el portal de impuestos")}},B=async e=>{try{const r={query:"deleteTaxPortal",params:{businessId:n.getBusinessId(),id:e}};await u(r)}catch(r){throw console.error("Error deleting tax portal:",r),new Error("Error al eliminar el portal de impuestos")}},f=()=>{const e=Date.now().toString(36),r=Math.random().toString(36).substring(2,12);return`TDR-${e}-${r}`.toUpperCase()},D=()=>Math.floor(1e5+Math.random()*9e5).toString(),I=(e,r)=>{const t=`${window.location.origin}/#/tax-upload/${e}/${r}`;return`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(t)}`},U=async(e,r)=>{try{const t=n.state.profile;t?.uid;const s=Date.now(),o=r.expirationDays||30,c=f(),a=y();console.log(e);const d={id:a,title:r?.task?.title,taxPortalId:e?.id,recipientName:`${e?.firstName} ${e?.lastName}`.trim(),clientName:`${e?.firstName} ${e?.lastName}`.trim(),clientEmail:e?.email,recipientEmail:e?.email,clientPhone:e?.phone,accessToken:c,accessPin:D(),qrCodeUrl:I(a,c),taxYear:r.taxYear,requestedDocuments:r.requestedDocuments||[...w],instructions:r.instructions,status:"pending",uploadedDocuments:[],createdAt:s,expiresAt:s+o*24*60*60*1e3,requestedBy:t.uid,requestedByName:t.displayName||t.email||"Unknown",businessId:n.getBusinessId()||"",storeId:e?.storeId,storeName:e?.storeName},l={query:"addTaxDocumentRequest",params:{businessId:n.getBusinessId()},form:d};return console.log("Creating document request:",l),(await u(l))?.documentRequest||d}catch(t){throw console.error("Error creating document request:",t),new Error("Error al crear la solicitud de documentos")}},A=async(e,r)=>{try{const o=(await m({query:"getTaxDocumentRequestByToken",params:{accessToken:r,id:e}}))?.data;if(!o)return null;o.expiresAt<Date.now()&&o.status==="pending"&&(o.status="expired");try{await g(o.id,o.businessId)}catch{}return o}catch(t){return console.error("Error getting document request by token:",t),null}},P=async e=>{try{const s=(await u({query:"getTaxDocumentRequestByPin",params:{accessPin:e}}))?.documentRequest;if(!s)return null;s.expiresAt<Date.now()&&s.status==="pending"&&(s.status="expired");try{await g(s.id,s.businessId)}catch{}return s}catch(r){return console.error("Error getting document request by PIN:",r),null}},g=async(e,r)=>{const t={query:"updateTaxDocumentRequestLastAccess",params:{businessId:r,id:e},form:{lastAccessedAt:Date.now()}};await m(t)},$=async e=>{try{const r={query:"getTaxDocumentRequestsByPortal",params:{businessId:n.getBusinessId(),taxPortalId:e}},t=await u(r);return t?.data?.data||t?.data||[]}catch(r){return console.error("Error getting document requests:",r),[]}},S=async e=>{try{if(!n.state.user)throw new Error("Usuario no autenticado");const t={query:"getTaxDocumentRequests",params:{businessId:n.getBusinessId()}},s=await u(t);let o=s?.data?.data||s?.data||[];if(!n.isAdmin()){const c=n.getAllowedStoreIds();o=o.filter(a=>a.storeId?c.includes(a.storeId):!0)}return e?.status,e?.taxYear,o.sort((c,a)=>a.createdAt-c.createdAt),o}catch(r){return console.error("Error getting document requests:",r),[]}},N=async(e,r,t,s)=>{try{const a=(await u({query:"getTaxDocumentRequestById",params:{businessId:r,id:e}}))?.documentRequest;if(!a)throw new Error("Request not found");const d=a.requestedDocuments.map(i=>i.type===t?{...i,uploaded:!0,documentId:s}:i),l=d.filter(i=>i.required).every(i=>i.uploaded),p=d.some(i=>i.uploaded),q={query:"updateTaxDocumentRequest",params:{businessId:r,id:e},form:{requestedDocuments:d,uploadedDocuments:[...a.uploadedDocuments||[],s],status:l?"complete":p?"partial":"pending"}};await u(q)}catch(o){throw console.error("Error marking document uploaded:",o),o}},k=async e=>{try{const r={query:"updateTaxDocumentRequest",params:{businessId:n.getBusinessId(),id:e},form:{status:"cancelled"}};await u(r)}catch(r){throw console.error("Error cancelling document request:",r),new Error("Error al cancelar la solicitud")}},C=async e=>{try{const r={query:"deleteTaxDocumentRequest",params:{businessId:n.getBusinessId(),id:e}};await u(r)}catch(r){throw console.error("Error deleting document request:",r),new Error("Error al eliminar la solicitud")}},M=async e=>{try{const r={query:"sendTaxDocumentRequestReminder",params:{businessId:n.getBusinessId(),id:e}},t=await u(r);t?.success&&await u({query:"updateTaxDocumentRequest",params:{businessId:n.getBusinessId(),id:e},form:{remindersSent:(t.remindersSent||0)+1}})}catch(r){throw console.error("Error sending reminder:",r),new Error("Error al enviar el recordatorio")}},v=e=>`${window.location.origin}/#/tax-upload/${e}`,L=()=>`${window.location.origin}/#/tax-upload-pin`,z=e=>{const r=Date.now(),t=e-r;if(t<=0)return"Expirado";const s=Math.floor(t/(24*60*60*1e3)),o=Math.floor(t%(24*60*60*1e3)/(60*60*1e3));return s>0?`${s} dÃ­a${s>1?"s":""} restante${s>1?"s":""}`:`${o} hora${o>1?"s":""} restante${o>1?"s":""}`},Q=e=>e.expiresAt<Date.now(),Y=e=>{const r=e.requestedDocuments.length,t=e.requestedDocuments.filter(s=>s.uploaded).length;return Math.round(t/r*100)},_=e=>e.requestedDocuments.filter(r=>r.required&&!r.uploaded),F=async(e,r,t)=>{try{const s=await m({query:"updateTaxDocumentRequest",params:{requestId:e,id:e,accessToken:r},form:t});return{success:!0}}catch(s){return console.error("Error updating document request:",s),{success:!1,error:s.message}}};async function O(e,r,t,s){try{const o=await e.arrayBuffer(),c=Array.from(new Uint8Array(o)),a=await m({query:"uploadTaxDocument",params:{businessId:s?.businessId||n.getBusinessId()},form:{fileBuffer:c,fileName:e.name,mimeType:e.type,fileSize:e.size,taxPortalId:r,taxYear:t,businessId:s?.businessId||n.getBusinessId(),documentType:s?.documentType,tags:s?.tags,notes:s?.notes}});return a?.success&&a?.documentId?{success:!0,documentId:a.documentId,document:a.document}:{success:!1,error:a?.error||"Failed to upload document"}}catch(o){return console.error("Error uploading tax document:",o),{success:!1,error:o.message}}}export{Y as a,v as b,L as c,U as d,k as e,z as f,$ as g,C as h,Q as i,E as j,S as k,b as l,B as m,R as n,A as o,_ as p,F as q,O as r,M as s,N as t,T as u,P as v};
